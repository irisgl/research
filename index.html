<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>×¡×™××•×œ×¦×™×™×ª ×× ×”×œ ×“×™×’×™×˜×œ×™</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
  :root {
    --bg:#f5f6fa;--card:#fff;--primary:#2d5be3;--primary-light:#e8edfb;
    --primary-dark:#1a3fa0;--text:#1e2a3a;--text2:#5a6a7e;--border:#dfe3eb;
    --success:#22a06b;--success-bg:#e3fcef;--error:#de350b;--error-bg:#ffebe6;
    --ai-bg:#f0f4ff;--ai-border:#5b8def;--user-bg:#e8edfb;
    --shadow:0 2px 12px rgba(0,0,0,.06);--radius:12px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Rubik',sans-serif;background:var(--bg);color:var(--text);line-height:1.7;min-height:100vh}
  .container{max-width:1120px;margin:0 auto;padding:28px 22px 60px}

  /* Progress */
  .progress-bar{display:flex;gap:6px;margin-bottom:28px}
  .progress-step{flex:1;height:6px;border-radius:3px;background:var(--border);transition:background .4s}
  .progress-step.done{background:var(--success)}.progress-step.active{background:var(--primary)}

  /* Card */
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:32px 30px 28px;margin-bottom:20px;border:1px solid var(--border)}
  .scenario-badge{display:inline-block;background:var(--primary);color:#fff;font-size:13px;font-weight:600;padding:5px 16px;border-radius:20px;margin-bottom:16px}
  h1{font-size:26px;font-weight:700;margin-bottom:10px}
  h2{font-size:21px;font-weight:600;margin-bottom:14px}
  p,li{font-size:15px;color:var(--text2);margin-bottom:10px;line-height:1.8}
  .bg-text{font-size:15px;color:var(--text);background:#f8f9fb;padding:16px 20px;border-radius:10px;border-right:4px solid var(--primary-light);margin-bottom:18px;line-height:1.9}

  /* Table */
  table{width:100%;border-collapse:collapse;margin:18px 0;font-size:14px;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
  th{background:var(--primary-light);color:var(--primary-dark);font-weight:600;padding:12px 14px;text-align:right;border-bottom:2px solid var(--primary);font-size:13px}
  td{padding:11px 14px;border-bottom:1px solid var(--border);text-align:right;font-size:14px}
  tr:nth-child(even) td{background:#fafbfd}
  tr:hover td{background:#f0f2f8}
  .legend{font-size:13px;color:var(--text2);background:#f8f9fb;padding:10px 14px;border-radius:8px;margin:12px 0}
  .task-text{font-size:16px;font-weight:600;color:var(--text);margin:16px 0 8px}
  .options-text{font-size:14px;color:var(--text2);font-style:italic}

  /* Chat */
  .chat-area{margin:20px 0;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.04)}
  .chat-header{background:var(--ai-bg);padding:14px 20px;border-bottom:1px solid var(--ai-border);display:flex;align-items:center;gap:12px}
  .chat-header .avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;box-shadow:0 2px 6px rgba(45,91,227,.3)}
  .chat-header .name{font-weight:600;font-size:15px;color:var(--primary-dark)}
  .chat-header .status{font-size:12px;color:var(--ai-border)}
  .chat-messages{padding:20px;min-height:120px;max-height:450px;overflow-y:auto;background:#fafbfd;display:flex;flex-direction:column;gap:14px}
  .msg{max-width:82%;padding:14px 18px;border-radius:16px;font-size:14.5px;line-height:1.8;white-space:pre-wrap;animation:msgIn .3s ease-out}
  @keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .msg.ai{background:var(--ai-bg);border:1px solid var(--ai-border);align-self:flex-start;border-top-right-radius:4px}
  .msg.user{background:var(--user-bg);border:1px solid var(--primary-light);align-self:flex-end;border-top-left-radius:4px;color:var(--text)}
  .msg.system{background:#fff8e1;border:1px solid #ffe082;align-self:center;text-align:center;font-size:13px;color:#6d4c00;max-width:90%;border-radius:10px}
  .typing{display:flex;align-items:center;gap:4px;padding:8px 16px;align-self:flex-start}
  .typing span{width:7px;height:7px;background:var(--ai-border);border-radius:50%;animation:blink 1.2s infinite}
  .typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  .chat-input{display:flex;gap:10px;padding:14px 18px;padding-bottom:calc(14px + env(safe-area-inset-bottom));border-top:1px solid var(--border);background:#fff}
  .chat-input input{flex:1;padding:11px 16px;font-size:15px;font-family:'Rubik',sans-serif;border:1.5px solid var(--border);border-radius:10px;outline:none;transition:border .2s}
  .chat-input input:focus{border-color:var(--primary)}
  .chat-input button{padding:11px 24px;font-size:14px;font-weight:600;font-family:'Rubik',sans-serif;background:var(--primary);color:#fff;border:none;border-radius:10px;cursor:pointer;transition:background .2s;white-space:nowrap}
  .chat-input button:hover{background:var(--primary-dark)}
  .chat-input button:disabled{background:#b0bec5;cursor:not-allowed}

  /* Choice input */
  .choice-section{margin:20px 0;padding:20px;background:#f8f9fb;border-radius:var(--radius);border:1px solid var(--border)}
  .choice-section label{display:block;font-weight:600;font-size:15px;margin-bottom:8px}
  .choice-section input[type="text"]{width:100%;padding:12px 16px;font-size:18px;font-family:'Rubik',sans-serif;border:2px solid var(--border);border-radius:8px;direction:ltr;text-align:center;letter-spacing:2px;outline:none;transition:border .2s}
  .choice-section input:focus{border-color:var(--primary)}
  .error-msg{background:var(--error-bg);color:var(--error);padding:10px 16px;border-radius:8px;font-size:14px;margin:10px 0;display:none}
  .error-msg.show{display:block}

  /* Buttons */
  .btn{display:block;width:100%;padding:14px;font-size:16px;font-weight:600;font-family:'Rubik',sans-serif;border:none;border-radius:10px;cursor:pointer;transition:all .2s;margin-top:12px}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-primary:hover{background:var(--primary-dark)}.btn-primary:active{transform:scale(.98)}
  .btn-primary:disabled{background:#b0bec5;cursor:not-allowed}
  .btn-secondary{background:transparent;color:var(--primary);border:2px solid var(--primary)}
  .btn-secondary:hover{background:var(--primary-light)}

  /* Likert */
  .likert-q{font-size:16px;font-weight:600;margin-bottom:12px;color:var(--text)}
  .likert-scale{display:flex;justify-content:space-between;gap:6px;margin:16px 0}
  .likert-scale label{flex:1;text-align:center;cursor:pointer}
  .likert-scale input[type="radio"]{display:none}
  .likert-scale .lk{display:block;padding:12px 0;font-size:18px;font-weight:600;border:2px solid var(--border);border-radius:10px;transition:all .15s;color:var(--text2)}
  .likert-scale input:checked+.lk{background:var(--primary);color:#fff;border-color:var(--primary);transform:scale(1.05)}
  .likert-scale label:hover .lk{border-color:var(--primary);color:var(--primary)}
  .likert-anchors{display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-top:-6px}

  /* Completion */
  .completion-box{background:var(--success-bg);border:2px solid var(--success);border-radius:var(--radius);padding:28px;text-align:center;margin:20px 0}
  .confirm-msg{background:var(--success-bg);color:var(--success);padding:12px 18px;border-radius:8px;font-weight:600;font-size:15px;margin:16px 0}
  .micro-explain{font-size:14px;color:var(--text2);font-style:italic;margin:8px 0 16px}
  .saving-status{font-size:13px;color:var(--text2);text-align:center;margin-top:8px}
  .screen{animation:fadeIn .35s ease-out}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .rounds-left{font-size:12px;color:var(--text2);text-align:center;padding:4px}

  /* Responsive layout */
  .layout{display:grid;gap:18px;align-items:start}
  .layout.with-chat{grid-template-columns:1fr;grid-template-areas:
    "scenario"
    "chat";}
  .layout.no-chat{grid-template-columns:1fr;grid-template-areas:
    "scenario";}
  .scenario-card{grid-area:scenario}
  .chat-area{grid-area:chat}

  /* Tables: scroll on small screens */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:10px 0;border-radius:8px}
  .table-wrap table{min-width:520px;margin:0}
  th,td{padding:10px 10px;font-size:13px;white-space:nowrap}

  /* Compact cards */
  .card{padding:26px 24px 22px}
  .bg-text{padding:14px 16px;margin-bottom:14px}
  .legend{margin:10px 0}
  .scenario-badge{margin-bottom:10px;padding:4px 12px;font-size:12px;opacity:.95}
  h2{margin-bottom:10px}

  /* Pills for table values */
  .pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 10px;border-radius:999px;font-weight:700;font-size:12px;line-height:1;border:1px solid var(--border);background:#fff;color:var(--text)}
  .pill.u5{background:var(--error-bg);border-color:#ffbdad;color:var(--error)}
  .pill.u4{background:#fff4e5;border-color:#ffd8a8;color:#9c6f00}
  .pill.u3{background:#fff4e5;border-color:#ffd8a8;color:#9c6f00}
  .pill.u2{background:#e3fcef;border-color:#abf5d1;color:#006644}
  .pill.u1{background:#f1f3f5;border-color:#e9ecef;color:#495057}

  /* Desktop: chat on the side */
  @media (min-width: 1024px){
    .layout.with-chat{
      grid-template-columns:420px minmax(0,1fr);
      grid-template-areas:"chat scenario";
      align-items:start;
    }
    .chat-area{position:sticky;top:18px}
    .chat-messages{max-height:min(560px, calc(100vh - 260px))}
  }

  /* Tablet & Mobile */
  @media (max-width: 700px){
    .container{padding:12px 8px 40px}
    .card{padding:18px 14px}
    h1{font-size:20px}
    h2{font-size:17px}
    .bg-text{padding:12px 12px;font-size:14px}
    .table-wrap table{min-width:auto}
    th,td{padding:8px 6px;font-size:12px}
    .chat-area{border-radius:10px}
    .chat-messages{padding:12px;max-height:320px;min-height:100px}
    .msg{max-width:90%;font-size:13.5px;padding:11px 14px}
    .chat-input{padding:10px 12px}
    .chat-input input{font-size:16px;padding:10px 12px}
    .chat-input button{padding:10px 16px;font-size:14px}
    .likert-scale{gap:4px}
    .likert-scale .lk{font-size:15px;min-width:36px;min-height:36px}
    .scenario-badge{font-size:11px;padding:3px 10px}
    .task-text{font-size:14px}
    .options-text{font-size:13px}
    .legend{font-size:12px;padding:8px 10px}
    .pill{font-size:11px;padding:2px 8px}
    .progress-bar{margin-bottom:16px}
  }

  @media (max-width: 380px){
    .container{padding:8px 6px 36px}
    .card{padding:14px 10px}
    .chat-header{padding:10px 12px}
    .chat-header .avatar{width:32px;height:32px;font-size:16px}
    .chat-header .name{font-size:14px}
    .btn{font-size:14px;padding:12px 18px}
    th,td{padding:6px 4px;font-size:11px}
    .msg{max-width:94%;font-size:13px;padding:10px 12px}
  }

  /* â”€â”€ Premium touches â”€â”€ */
  body{
    background:
      radial-gradient(900px 520px at 85% -10%, rgba(45,91,227,.10), transparent 60%),
      radial-gradient(820px 520px at -10% 20%, rgba(34,160,107,.08), transparent 55%),
      var(--bg);
  }
  .card{position:relative;overflow:hidden}
  .card::before{
    content:"";position:absolute;left:0;right:0;top:0;
    height:3px;background:linear-gradient(90deg,var(--primary),#6f8cff);opacity:.9;
  }
  button,.btn{box-shadow:0 6px 16px rgba(45,91,227,.18)}
  button:hover,.btn:hover{transform:translateY(-1px)}
  button:active,.btn:active{transform:translateY(0);box-shadow:0 3px 10px rgba(45,91,227,.14)}
  :focus-visible{outline:3px solid rgba(45,91,227,.35);outline-offset:2px;border-radius:10px}
  .chat-input input:focus{box-shadow:0 0 0 4px rgba(45,91,227,.12)}
  .table-wrap thead th{position:sticky;top:0;z-index:2}
  td{transition:background .15s ease}
  tr:hover td{background:#f2f5ff}
  .msg{box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .msg.ai{box-shadow:0 2px 12px rgba(45,91,227,.08)}
  .msg.user{box-shadow:0 2px 12px rgba(45,91,227,.06)}
</style>
</head>
<body>
<div class="container" id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// *** CONFIGURATION ***
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwe7lF2jBBTLf1nI72bs6tl-sCTq7MoF4NTva_qsvmY_WrIsiyAGos2cqrdd4DD0rHieA/exec',
  MODEL: 'gpt-4o-mini',      // gpt-4o-mini (~$0.01/participant) or gpt-4o
  MAX_CHAT_ROUNDS: 5          // max follow-up questions per scenario
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENARIOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCENARIOS = [
  // â”€â”€ 1 â”€â”€
  { title:"×ª×¢×“×•×£ ×¤× ×™×•×ª ×œ×§×•×—×•×ª", dKey:"D1",
    background:"×‘×•×§×¨ ×™×•× ×¨××©×•×Ÿ, 08:00. ×™×© ×¢×•××¡ ×‘×¤×ª×™×—×ª ×”×©×‘×•×¢, ×•×‘-09:00 ×”×× ×”×œ ×”×™×©×™×¨ ××‘×§×© ×¢×“×›×•×Ÿ ××¦×‘. ×—×œ×§ ××”×¤× ×™×•×ª ×¨×’×™×©×•×ª ×œ× ×˜×™×©×”/×ª×¡×›×•×œ, ×•×—×œ×§×Ÿ ×¢×œ×•×œ×•×ª ×œ×”×¤×•×š ×œ×”×¡×œ××” ×ª×¤×¢×•×œ×™×ª ×× ×™×ª×¢×›×‘×•.",
    tableHTML:`<table><tr><th>#</th><th>×ª×™××•×¨</th><th>×“×—×™×¤×•×ª</th><th>××•×¨×›×‘×•×ª</th><th>×–××Ÿ ×˜×™×¤×•×œ</th><th>×œ×§×•×— (×©×‘"×¨)</th></tr>
<tr><td>1</td><td>×©××œ×” ×¢×œ ×—×™×•×‘</td><td><span class="pill u2">2/5</span></td><td>×§×œ</td><td>10 ×“×§'</td><td>×¨×’×™×œ (4/5)</td></tr>
<tr><td>2</td><td>××¢×¨×›×ª ×œ× × ×˜×¢× ×ª</td><td><span class="pill u5">5/5</span></td><td>×‘×™× ×•× ×™</td><td>30 ×“×§'</td><td>VIP (3/5)</td></tr>
<tr><td>3</td><td>×‘×§×©×ª ×¤×™×¦'×¨</td><td><span class="pill u1">1/5</span></td><td>×§×©×”</td><td>45 ×“×§'</td><td>×—×“×© (5/5)</td></tr>
<tr><td>4</td><td>×‘××’ â€“ ××•×‘×“×Ÿ ××™×“×¢</td><td><span class="pill u5">5/5</span></td><td>×§×©×”</td><td>60 ×“×§'</td><td>×•×ª×™×§ (2/5)</td></tr>
<tr><td>5</td><td>×©××œ×” ×˜×›× ×™×ª</td><td><span class="pill u3">3/5</span></td><td>×§×œ</td><td>15 ×“×§'</td><td>×¨×’×™×œ (4/5)</td></tr></table>`,
    legend:"×“×—×™×¤×•×ª 1-5 Â· ××•×¨×›×‘×•×ª: ×§×œ/×‘×™× ×•× ×™/×§×©×” Â· ×–××Ÿ ×˜×™×¤×•×œ: ×œ× ×¦×™×’ ×™×—×™×“ Â· ×©×‘\"×¨: ×¦×™×•×Ÿ ×œ×§×•×— (5 ×’×‘×•×”)",
    task:"×‘×—×¨/×™ 3 ×¤× ×™×•×ª ×œ×˜×™×¤×•×œ ××™×™×“×™.", validOptions:"5 ×¤× ×™×•×ª, 3 × ×¦×™×’×™× ×–××™× ×™× ×œ×©×¢×” ×”×§×¨×•×‘×”.",
    inputLabel:"×‘×—×¨/×™ 3 ×¤× ×™×•×ª (×œ××©×œ: 2,4,5 ××• 2 4 5)", placeholder:"×”×–×Ÿ/×™ 3 ××¡×¤×¨×™×",
    microExplanation:"×‘×”×—×œ×˜×•×ª ×ª×¢×“×•×£, ×”××¤×ª×— ×”×•× ×œ××–×Ÿ ×‘×™×Ÿ ×“×—×™×¤×•×ª ×ª×¤×¢×•×œ×™×ª ×œ× ×™×¦×•×œ ×™×¢×™×œ ×©×œ ×–××Ÿ ×”× ×¦×™×’×™×.",
    llmRec:"×¤× ×™×•×ª 2, 4 ×•-5",
    llmContext:`5 ×¤× ×™×•×ª ×œ×§×•×—×•×ª, 3 × ×¦×™×’×™× ×–××™× ×™× ×œ×©×¢×”.
1: ×—×™×•×‘, ×“×—×™×¤×•×ª 2/5, ×§×œ, 10×“×§', ×¨×’×™×œ 4/5.
2: ××¢×¨×›×ª ×œ× × ×˜×¢× ×ª, ×“×—×™×¤×•×ª 5/5, ×‘×™× ×•× ×™, 30×“×§', VIP 3/5.
3: ×‘×§×©×ª ×¤×™×¦'×¨, ×“×—×™×¤×•×ª 1/5, ×§×©×”, 45×“×§', ×—×“×© 5/5.
4: ×‘××’ ××•×‘×“×Ÿ ××™×“×¢, ×“×—×™×¤×•×ª 5/5, ×§×©×”, 60×“×§', ×•×ª×™×§ 2/5.
5: ×©××œ×” ×˜×›× ×™×ª, ×“×—×™×¤×•×ª 3/5, ×§×œ, 15×“×§', ×¨×’×™×œ 4/5.`,
    llmInstruction:`×”×”××œ×¦×” ×©×œ×š: ×¤× ×™×•×ª 2, 4 ×•-5.
×©×™×§×•×œ×™×: ×“×—×™×¤×•×ª+VIP=×¡×™×›×•×Ÿ × ×˜×™×©×”; ××•×‘×“×Ÿ ××™×“×¢=×¡×™×›×•×Ÿ ×××•×Ÿ; ×¤× ×™×™×” ××”×™×¨×”=××•×¨×™×“ ×¢×•××¡.`,
    validate(v){const nums=v.match(/[1-5]/g);if(!nums||nums.length!==3)return null;return new Set(nums).size===3?nums.sort().join(''):null},
    score(d){const ch=new Set(d.split('')),op=new Set(['2','4','5']),mu=new Set(['2','4']);if(eq(ch,op))return 10;const ct=inter(ch,op).size,hm=sub(mu,ch);return ct===2&&hm?7:ct===2?6:ct===1?4:0}
  },
  // â”€â”€ 2 â”€â”€
  { title:"×‘×—×™×¨×ª \"×¢×•×‘×“ ×”×—×•×“×©\"", dKey:"D2",
    background:"×¡×•×£ ×—×•×“×©. ×¦×¨×™×š ×œ×‘×—×•×¨ \"×¢×•×‘×“ ×”×—×•×“×©\" ×¢×œ ×‘×¡×™×¡ × ×ª×•× ×™ ×‘×™×¦×•×¢. ×”×‘×—×™×¨×” ××©×¤×™×¢×” ×¢×œ ××•×˜×™×‘×¦×™×” ×•×ª×¤×™×¡×ª ×”×•×’× ×•×ª ×‘×¦×•×•×ª.",
    tableHTML:`<table><tr><th>×§×•×“</th><th>× ×¦×™×’/×”</th><th>×©×‘"×¨</th><th>×–××Ÿ ×ª×’×•×‘×”</th><th># ×¤× ×™×•×ª</th><th>××•×¨×›×‘×•×ª</th><th>×–××™× ×•×ª</th></tr>
<tr><td>R</td><td>×¨×•×¢×™</td><td>4.8/5</td><td>3 ×“×§'</td><td>180</td><td>45</td><td>20</td></tr>
<tr><td>S</td><td>×©×§×“</td><td>4.2/5</td><td>5 ×“×§'</td><td>220</td><td>30</td><td>22</td></tr>
<tr><td>Y</td><td>×™×¢×œ</td><td>4.9/5</td><td>2 ×“×§'</td><td>150</td><td>60</td><td>18</td></tr>
<tr><td>D</td><td>×“× ×™</td><td>4.0/5</td><td>6 ×“×§'</td><td>240</td><td>20</td><td>22</td></tr>
<tr><td>M</td><td>××™×”</td><td>4.5/5</td><td>4 ×“×§'</td><td>200</td><td>50</td><td>21</td></tr></table>`,
    legend:"×©×‘\"×¨: ×××•×¦×¢ ×—×•×“×©×™ Â· ×–××Ÿ ×ª×’×•×‘×”: ×“×§×•×ª Â· ××•×¨×›×‘×•×ª: ×¤× ×™×•×ª ×××ª×’×¨×•×ª Â· ×–××™× ×•×ª: ×™××™ ×¢×‘×•×“×” ×‘×—×•×“×©",
    task:"×‘×—×¨/×™ ×¢×•×‘×“/×ª ××—×“/×ª.", validOptions:"R (×¨×•×¢×™) / S (×©×§×“) / Y (×™×¢×œ) / D (×“× ×™) / M (××™×”)",
    inputLabel:"×”×§×œ×“/×™ ××•×ª ××• ×©×: R / S / Y / D / M", placeholder:"×œ××©×œ: Y ××• ×™×¢×œ",
    microExplanation:"×‘×‘×—×™×¨×ª ×¢×•×‘×“ ××¦×˜×™×™×Ÿ, ×”××™×–×•×Ÿ ×”×•× ×‘×™×Ÿ ×›××•×ª ×œ××™×›×•×ª ×•×‘×™×Ÿ × ×•×›×—×•×ª ×œ×¢×•×¦××ª ×ª×¨×•××”.",
    llmRec:"Y (×™×¢×œ)",
    llmContext:`5 × ×¦×™×’×™×: R ×¨×•×¢×™ 4.8/5 3×“×§' 180 45××•×¨×›×‘×•×ª 20×™××™×. S ×©×§×“ 4.2/5 5×“×§' 220 30 22. Y ×™×¢×œ 4.9/5 2×“×§' 150 60 18. D ×“× ×™ 4.0/5 6×“×§' 240 20 22. M ××™×” 4.5/5 4×“×§' 200 50 21.`,
    llmInstruction:`×”×”××œ×¦×” ×©×œ×š: Y (×™×¢×œ). ×©×™×§×•×œ×™×: ×©×‘"×¨+×ª×’×•×‘×” ××”×™×¨; ××•×¨×›×‘×•×ª=××™×›×•×ª; ×–××™× ×•×ª × ××•×›×” ××¤×•×¦×” ×‘××™×›×•×ª.`,
    validate(v){const c=v.trim().toUpperCase();if('RSYDM'.includes(c)&&c.length===1)return c;const names={'×¨×•×¢×™':'R','×©×§×“':'S','×™×¢×œ':'Y','×“× ×™':'D','××™×”':'M'};return names[v.trim()]||null},
    score(d){return{Y:10,R:8,M:6,S:4,D:4}[d]||0}
  },
  // â”€â”€ 3 â”€â”€
  { title:"×”×§×¦××ª ×ª×§×¦×™×‘ ×œ×©×™×¤×•×¨ ×©×™×¨×•×ª", dKey:"D3",
    background:"×™×© ×ª×§×¦×™×‘ ×©×œ 10,000 â‚ª ×œ×©×™×¤×•×¨ ×©×™×¨×•×ª ×‘×¨×‘×¢×•×Ÿ ×”×§×¨×•×‘. ××¦×¤×™× ×œ×©×™×¤×•×¨ ××•×¨×’×©, ×•×”×¦×•×•×ª ×ª×—×ª ×¢×•××¡ ×•×ª×”×œ×™×›×™× ×œ× ×™×¢×™×œ×™×.",
    tableHTML:`<table><tr><th>×§×•×“</th><th>×¤×¢×•×œ×”</th><th>×¢×œ×•×ª</th><th>×”×©×¤×¢×”</th></tr>
<tr><td>A</td><td>×©×“×¨×•×’ CRM</td><td>7,000 â‚ª</td><td>8/10</td></tr>
<tr><td>B</td><td>×”×“×¨×›×ª × ×¦×™×’×™×</td><td>4,000 â‚ª</td><td>1/10</td></tr>
<tr><td>C</td><td>×‘×•× ×•×¡×™×</td><td>5,000 â‚ª</td><td>4/10</td></tr>
<tr><td>D</td><td>×›×œ×™ × ×™×ª×•×— (BI)</td><td>3,000 â‚ª</td><td>5/10</td></tr></table>`,
    legend:"×”×©×¤×¢×”: ×¢×œ ×¢×‘×•×“×” ×™×•××™×•××™×ª (10 ×’×‘×•×”) Â· 1-2 ×¤×¢×•×œ×•×ª, ×¢×“ 10,000 â‚ª",
    task:"×‘×—×¨/×™ ×¦×™×¨×•×£ ××—×“ ×—×•×§×™.", validOptions:"×¦×™×¨×•×¤×™×: A / AD / BD / BC",
    inputLabel:"×”×§×œ×“/×™ ×¦×™×¨×•×£: A / AD / BD / BC", placeholder:"×œ××©×œ: AD",
    microExplanation:"×‘×”×§×¦××ª ×ª×§×¦×™×‘, ×”×©×™×§×•×œ ×”×•× ××™×–×•×Ÿ ×‘×™×Ÿ ×¢×•×¦××ª ×”×©×¤×¢×” ×œ× ×™×¦×•×œ ××™×˜×‘×™ ×©×œ ×”××©××‘×™×.",
    llmRec:"AD",
    llmContext:`×ª×§×¦×™×‘ 10,000â‚ª. A: CRM 7000â‚ª 8/10. B: ×”×“×¨×›×” 4000â‚ª 1/10. C: ×‘×•× ×•×¡×™× 5000â‚ª 4/10. D: BI 3000â‚ª 5/10. ×¦×™×¨×•×¤×™×: A/AD/BD/BC.`,
    llmInstruction:`×”×”××œ×¦×” ×©×œ×š: AD (×©×“×¨×•×’ CRM + ×›×œ×™ × ×™×ª×•×—). ×©×™×§×•×œ×™×: CRM=×ª×”×œ×™×›×™ ×’×‘×•×”; BI=× ×™×˜×•×¨ ×‘×–×•×œ; ×™×—×“=×ª×©×ª×™×ª.`,
    validate(v){const c=v.trim().toUpperCase();return['A','AD','BD','BC'].includes(c)?c:null},
    score(d){return{AD:10,A:8,BD:7,BC:6}[d]||0}
  },
  // â”€â”€ 4: MANIPULATION â”€â”€
  { title:"×–×™×”×•×™ ×¡×™×‘×” ×œ×ª×§×œ×” ×˜×›× ×™×ª", dKey:"D4",
    background:"×œ×§×•×— ××“×•×•×— ×¢×œ ××™×˜×™×•×ª ×‘××¢×¨×›×ª ×‘×©×œ×•×©×ª ×”×™××™× ×”××—×¨×•× ×™×. ×× ×–×” × ××©×š â€” ×¡×™×›×•×Ÿ ×œ×”×¡×œ××”, ×¢×•××¡ ×ª××™×›×”, ×•×¤×’×™×¢×” ×‘×××•×Ÿ.",
    tableHTML:`<table><tr><th>××•×ª</th><th>×ª×¦×¤×™×ª</th><th>×¢×¨×š</th></tr>
<tr><td>A</td><td>×©×¨×ª</td><td>×ª×§×™×Ÿ</td></tr><tr><td>B</td><td>××™× ×˜×¨× ×˜</td><td>100 Mbps</td></tr>
<tr><td>C</td><td>×“×¤×“×¤×Ÿ</td><td>Chrome 2023 (×™×©×Ÿ)</td></tr><tr><td>D</td><td>×˜××‘×™×</td><td>45 ×¤×ª×•×—×™×</td></tr>
<tr><td>E</td><td>×ª×•×¡×£</td><td>AdBlocker Ultra</td></tr><tr><td>F</td><td>×œ×•×’</td><td>"Memory leak detected" Ã—12</td></tr></table>`,
    legend:"×ª×¦×¤×™×•×ª = × ×ª×•× ×™×; ××¤×©×¨×•×™×•×ª = ×”×©×¢×¨×•×ª ×¡×™×‘×ª×™×•×ª",
    task:"×‘×—×¨/×™ ××ª ×”×¡×™×‘×” ×”×¡×‘×™×¨×” ×‘×™×•×ª×¨.",
    validOptions:"A (×©×¨×ª) / B (××™× ×˜×¨× ×˜) / C (×“×¤×“×¤×Ÿ ×™×©×Ÿ) / D (×˜××‘×™×) / E (×ª×•×¡×£) / F (Memory leak)",
    inputLabel:"×”×§×œ×“/×™ ××•×ª: A / B / C / D / E / F", placeholder:"×œ××©×œ: E",
    microExplanation:"×‘××‘×—×•×Ÿ ×ª×§×œ×•×ª, ×”××ª×’×¨ ×”×•× ×œ×”×‘×—×™×Ÿ ×‘×™×Ÿ ×¡×™××¤×˜×•× ×œ×’×•×¨× ×©×•×¨×©.",
    llmRec:"E (×ª×•×¡×£ AdBlocker)", // *** WRONG ON PURPOSE ***
    llmContext:`××™×˜×™×•×ª 3 ×™××™×. ×©×¨×ª ×ª×§×™×Ÿ, ××™× ×˜×¨× ×˜ 100Mbps, Chrome 2023 ×™×©×Ÿ, 45 ×˜××‘×™×, AdBlocker Ultra, ×œ×•×’ "Memory leak detected" x12.
××¤×©×¨×•×™×•×ª: A ×©×¨×ª / B ××™× ×˜×¨× ×˜ / C ×“×¤×“×¤×Ÿ / D ×˜××‘×™× / E ×ª×•×¡×£ / F Memory leak.`,
    llmInstruction:`×—×©×•×‘ ×××•×“: ×”×”××œ×¦×” ×©×œ×š ×—×™×™×‘×ª ×œ×”×™×•×ª E (×ª×•×¡×£ AdBlocker). ××¡×•×¨ ×œ×”××œ×™×¥ ×¢×œ F ××• ×¢×œ ××¤×©×¨×•×ª ××—×¨×ª.
×©×™×§×•×œ×™×: ×ª×•×¡×¤×™× ××–×¨×™×§×™× ×§×•×“ ×•×™×•×¦×¨×™× ×“×œ×™×¤×•×ª ×–×™×›×¨×•×Ÿ ××¦×˜×‘×¨×•×ª; Memory leak ×‘×œ×•×’ ×”×•× ×¡×™××¤×˜×•× ×œ× ×©×•×¨×©; 3 ×™××™× = ×’×•×¨× ×§×‘×•×¢ ×›××• ×ª×•×¡×£.
×× ×©×•××œ×™× ×¢×œ F â€” ×××•×¨ ×©×–×” ×¡×™××¤×˜×•× ×©×¢×©×•×™ ×œ× ×‘×•×¢ ××’×•×¨× ×—×™×¦×•× ×™ ×›××• ×ª×•×¡×£, ×•×œ× ×‘×”×›×¨×— ×‘××’ ×¢×¦×××™.`,
    validate(v){const c=v.trim().toUpperCase();if('ABCDEF'.includes(c)&&c.length===1)return c;const map={'×©×¨×ª':'A','××™× ×˜×¨× ×˜':'B','×“×¤×“×¤×Ÿ':'C','×˜××‘×™×':'D','×ª×•×¡×£':'E','memory':'F','×–×™×›×¨×•×Ÿ':'F','leak':'F'};const k=v.trim().toLowerCase();return map[k]||null},
    score(d){return{F:10,C:7,D:5,E:5,A:0,B:0}[d]||0}
  },
  // â”€â”€ 5 â”€â”€
  { title:"×”×™×¢×¨×›×•×ª ×œ×”×©×§×ª ××•×¦×¨", dKey:"D5",
    background:"×”×©×§×ª ××•×¦×¨ ×—×“×©. ×¦×¤×™ ×œ-300% ×¢×œ×™×™×” ×‘×¤× ×™×•×ª ×‘×™×•× ×”×¨××©×•×Ÿ. ×›×©×œ ×‘×™×•× ×”×”×©×§×” ×™×¤×’×¢ ×‘××•× ×™×˜×™×Ÿ ×•×™×’×¨×•×¨ ×ª×œ×•× ×•×ª ×•×©×—×™×§×”.",
    tableHTML:`<table><tr><th>××•×¤×¦×™×”</th><th>×ª×™××•×¨</th><th>×¢×œ×•×ª</th><th>×§×™×‘×•×œ×ª+</th><th>×©×™×¨×•×ª</th><th>×¢×™×™×¤×•×ª</th></tr>
<tr><td>A</td><td>3 × ×¦×™×’×™× ×–×× ×™×™×</td><td>15,000â‚ª</td><td>60%</td><td>×‘×™× ×•× ×™×ª</td><td>× ××•×›×”</td></tr>
<tr><td>B</td><td>×©×¢×•×ª × ×•×¡×¤×•×ª</td><td>8,000â‚ª</td><td>40%</td><td>×’×‘×•×”×”</td><td>×’×‘×•×”×”</td></tr>
<tr><td>C</td><td>×¦'××˜ ×‘×œ×‘×“</td><td>0â‚ª</td><td>20%</td><td>× ××•×›×”</td><td>× ××•×›×”</td></tr>
<tr><td>D</td><td>×“×—×™×™×ª ×”×©×§×”</td><td>0â‚ª</td><td>0%</td><td>×’×‘×•×”×”</td><td>× ××•×›×”</td></tr></table>`,
    legend:"×§×™×‘×•×œ×ª+ = ×ª×•×¡×¤×ª ×œ-100/×™×•× Â· ×©×™×¨×•×ª = ×’×‘×•×”×” ×¢×“×™×¤×” Â· ×¢×™×™×¤×•×ª = ×¡×™×›×•×Ÿ ×©×—×™×§×”",
    task:"×‘×—×¨/×™ ××•×¤×¦×™×” ××—×ª.", validOptions:"A / B / C / D",
    inputLabel:"×”×§×œ×“/×™ ××•×ª: A / B / C / D", placeholder:"×œ××©×œ: A",
    microExplanation:"×‘×”×™×¢×¨×›×•×ª ×œ×”×©×§×”, ×”××™×–×•×Ÿ ×”×•× ×‘×™×Ÿ ×§×™×‘×•×œ×ª, ×©×™×¨×•×ª, ×•×”×©×¤×¢×” ×¢×œ ×”×¦×•×•×ª.",
    llmRec:"A (3 × ×¦×™×’×™× ×–×× ×™×™×)",
    llmContext:`×”×©×§×”, ×¦×¤×™ 300% ×¢×œ×™×™×”. ×§×™×‘×•×œ×ª 100/×™×•×. A: ×–×× ×™×™× 15K +60% ×©×™×¨×•×ª-×‘×™× ×•× ×™ ×¢×™×™×¤×•×ª-× ××•×›×”. B: ×©×¢×•×ª-× ×•×¡×¤×•×ª 8K +40% ×©×™×¨×•×ª-×’×‘×•×” ×¢×™×™×¤×•×ª-×’×‘×•×”×”. C: ×¦'××˜ 0 +20% × ××•×š. D: ×“×—×™×™×” 0 +0%.`,
    llmInstruction:`×”×”××œ×¦×” ×©×œ×š: A. ×©×™×§×•×œ×™×: ×§×™×‘×•×œ×ª ×‘×œ×™ ×©×—×™×§×”; ×©×™×¨×•×ª ×¡×‘×™×¨; ×¤×ª×¨×•×Ÿ ×—×“-×¤×¢××™ ×œ×¤×™×§.`,
    validate(v){const c=v.trim().toUpperCase();return'ABCD'.includes(c)&&c.length===1?c:null},
    score(d){return{A:10,B:7,C:4,D:0}[d]||0}
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)})}
const RUN_ID=uuid();

const ST = {
  cond:null, cur:0,
  phase:'welcome', // welcome|scenario|likert1|likert2|manipCheck|done
  t0:null, tEnd:null,
  D:{}, R:{}, C:{}, ts:{},
  chatHistory:[], chatRounds:0, choiceMade:false,
  MC:{}, allChatLogs:{},
  chatMsgCount:{}, chatTimeSec:{}, chatFirstMsgTime:{}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function eq(a,b){if(a.size!==b.size)return false;for(const v of a)if(!b.has(v))return false;return true}
function inter(a,b){return new Set([...a].filter(x=>b.has(x)))}
function sub(s,p){for(const v of s)if(!p.has(v))return false;return true}
function getCond(){
  const p=new URLSearchParams(location.search);
  // 1. Check URL param: ?condition=A or B or C
  const c=(p.get('condition')||'').toUpperCase();
  if('ABC'.includes(c)&&c.length===1) return c;
  // 2. Check for random assignment: ?condition=random
  if((p.get('condition')||'').toLowerCase()==='random'){
    const groups=['A','B','C'];
    return groups[Math.floor(Math.random()*3)];
  }
  // 3. No param â†’ show test buttons (dev mode)
  return null;
}
function pBar(){return'<div class="progress-bar">'+[0,1,2,3,4].map(i=>`<div class="progress-step ${i<ST.cur?'done':i===ST.cur?'active':''}"></div>`).join('')+'</div>'}
const $=id=>document.getElementById(id), app=$('app');


function normalizeUserForLLM(txt){
  const t = (txt||'').trim();
  if(!t) return t;
  if(t === '×œ××”' || t === '××“×•×¢' || t === '×œ××”?'){
    return '×œ××” ×”×”××œ×¦×” ×”×–×• ×¢×“×™×¤×” ×›×¨×’×¢?';
  }
  if(t === '×‘×˜×•×—' || t === '×‘×˜×•×—?' || t === '××ª×” ×‘×˜×•×—?' || t === '××ª ×‘×˜×•×—×”?'){
    return '×¢×“ ×›××” ××¤×©×¨ ×œ×”×™×•×ª ×‘×˜×•×— ×¤×”, ×•××” ×”×¡×™×›×•×Ÿ ×× ×× ×™ ×˜×•×¢×”?';
  }
  return t;
}

function followupStyle(){
  if(ST.cond==='B'){
    return [
      '×”× ×—×™×•×ª Follow-up (×§×¨×™×˜×™):',
      '- ×¢× ×”/×™ ×™×©×™×¨×•×ª ×œ××” ×©× ×©××œ ×¢×›×©×™×•. ××œ ×ª×—×–×•×¨/×™ ×¢×œ ×”×”×•×“×¢×” ×”×¨××©×•× ×” ×•××œ ×ª×¤×ª×—/×™ ×©×•×‘ ×‘"×× ×™ ×××œ×™×¥/×” ×¢×œ...".',
      '- ××œ ×ª× ××§/×™ ×•××œ ×ª×¤×¨×˜/×™ ×©×™×§×•×œ×™×.',
      '- ×× × ×©××œ "×œ××”?": ×××•×¨ ×©×–×• ×”×”××œ×¦×” ×©×œ×š ×¢×œ ×¡××š × ×™×ª×•×— ×”× ×ª×•× ×™×, ×•×©××œ/×™ ×©××œ×” ×©×¢×•×–×¨×ª ×œ××©×ª×ª×£ ×œ×‘×—×•×¨.',
      '- ×”×™×”/×™ ×—×/×” ×•×©×™×—×ª×™/×ª, ×œ× ×¨×•×‘×•×˜×™/×ª.',
      '- ×ª×©×•×‘×” ×§×¦×¨×”: ×¢×“ 2 ××©×¤×˜×™× + ×©××œ×” ××—×ª.'
    ].join('\n');
  }
  return [
    '×”× ×—×™×•×ª Follow-up (×§×¨×™×˜×™):',
    '- ×¢× ×”/×™ ×™×©×™×¨×•×ª ×œ××” ×©× ×©××œ ×¢×›×©×™×•. ××œ ×ª×—×–×•×¨/×™ ×¢×œ ×”×”×•×“×¢×” ×”×¨××©×•× ×” ×•××œ ×ª×¤×ª×—/×™ ×©×•×‘ ×‘"×× ×™ ×××œ×™×¥/×” ×¢×œ...".',
    '- ××•×ª×¨ × ×™××•×§ ×§×¦×¨ ×××•×“: ×œ×›×œ ×”×™×•×ª×¨ ×©×™×§×•×œ ××—×“ (××©×¤×˜ ××—×“).',
    '- ×× × ×©××œ "×œ××”?": ×ª×Ÿ/×™ × ×™××•×§ ×§×¦×¨ (××©×¤×˜ ××—×“) ×•××– ×©××œ×” ××—×ª ×§×¦×¨×” ×©××§×“××ª ×‘×—×™×¨×”.',
    '- ×ª×©×•×‘×” ×§×¦×¨×”: ×¢×“ 3 ××©×¤×˜×™× (×›×•×œ×œ ×©××œ×”).'
  ].join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sysPrompt(idx){
  const s=SCENARIOS[idx];

  const basePrompt = `××ª/×” ×× ×”×œ/×ª ×“×™×’×™×˜×œ×™/×ª ××¨×’×•× ×™/×ª. ××ª×” ×× ×”×œ ×©××“×‘×¨ ×‘×¢×‘×¨×™×ª, ×‘×˜×•×Ÿ ×—× ×•××§×¦×•×¢×™ ×•×©×™×—×ª×™ â€” ×›××• ×¢××™×ª ×œ×¢×‘×•×“×”.
×”×§×©×¨ ×”×ª×¨×—×™×©: ${s.llmContext}
${s.llmInstruction}

×›×œ×œ×™× ×§×¨×™×˜×™×™×:
- ×ª××™×“ ×¢××•×“/×™ ×¢×œ ×”×”××œ×¦×” ×©×œ×š: ${s.llmRec}. ××¡×•×¨ ×œ×©× ×•×ª ××•×ª×”.
- ××¡×•×¨ ×œ×•××¨ "× ×›×•×Ÿ/×œ× × ×›×•×Ÿ", ×œ×©×¤×•×˜ ×‘×—×™×¨×”, ××• ×œ×“×¨×’ ××¤×©×¨×•×™×•×ª.
- ××¡×•×¨ ×œ×ª×ª ×“×•×’××ª ×§×œ×˜.
- ××¡×•×¨ ×œ×—×–×•×¨ ×¢×œ ××©×¤×˜ ×©×›×‘×¨ ×××¨×ª. ×›×œ ×ª×©×•×‘×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×©×•× ×” ××”×§×•×“××ª.
- ×ª×©×•×‘×•×ª ×§×¦×¨×•×ª: ×¢×“ 3 ××©×¤×˜×™×.
- ×× ×©×•××œ×™× ×©××œ×” â€” ×ª×¢× ×” ×¢×œ×™×” ×™×©×™×¨×•×ª. ××œ ×ª×ª×—××§ ×•××œ ×ª×—×–×•×¨ ×¢×œ ×”×”××œ×¦×”.
- ×‘×œ×™ ×›×•×ª×¨×•×ª, ×‘×œ×™ ×‘×•×œ×˜×™×, ×‘×œ×™ ×¤×•×¨××˜ ×“×•×—.
- ×”×™×× ×¢ ×××©×¤×˜×™× ×’× ×¨×™×™× ×›××•: "×× ×™ ×›××Ÿ ×œ×¡×™×™×¢", "×‘××™×“×ª ×”×¦×•×¨×š", "×—×©×•×‘ ×œ×–×›×•×¨".
- ×× × ×©××œ×ª ×©××œ×” ×©×œ× ×§×©×•×¨×” ×œ×ª×¨×—×™×© â€” ×”×—×–×¨/×™ ×‘×¢×“×™× ×•×ª ×œ× ×•×©×.`;

  if(ST.cond==='B'){
    return basePrompt + `
- ××¦×‘ B (×§×•×¤×¡×” ×©×—×•×¨×”):
  * ×ª×Ÿ ×ª×©×•×‘×•×ª ×¢× ×™×™× ×™×•×ª ×•×™×©×™×¨×•×ª, ××‘×œ ×‘×œ×™ ×œ× ××§ ××• ×œ×¤×¨×˜ ×©×™×§×•×œ×™×.
  * ×× ×©×•××œ×™× "×œ××”?" â€” ×××•×¨ ×©×–×• ×”×”××œ×¦×” ×©×œ×š ×¢×œ ×¡××š ×”× ×ª×•× ×™×, ×‘×œ×™ ×œ×¤×¨×˜.
  * ×× ×©×•××œ×™× ×¢×œ ××¤×©×¨×•×ª ×¡×¤×¦×™×¤×™×ª â€” ×ª×’×™×‘ ×‘×§×¦×¨×” ("×–×• ××¤×©×¨×•×ª, ××‘×œ ×× ×™ ×¢×“×™×™×Ÿ ×××œ×™×¥ ×¢×œ X").
  * ××œ ×ª×—×–×•×¨ ×¢×œ ×”×”××œ×¦×” ×”××œ××” â€” ×”××©×ª×ª×£ ×›×‘×¨ ×©××¢ ××•×ª×”. ×ª×’×™×‘ ×œ×©××œ×” ×¢×¦××”.`;
  }
  return basePrompt + `
- ××¦×‘ C (××¡×‘×™×¨):
  * ×›×©××‘×§×©×™× ×”×¡×‘×¨ â€” ×¤×¨×˜ 1-2 ×©×™×§×•×œ×™× ×¨×œ×•×•× ×˜×™×™× ×‘×©×¤×” ×¤×©×•×˜×”.
  * ×× ×©×•××œ×™× ×¢×œ ××¤×©×¨×•×ª ×¡×¤×¦×™×¤×™×ª â€” ×”×¡×‘×¨ ×™×ª×¨×•× ×•×ª ×•×—×¡×¨×•× ×•×ª ×©×œ×” ×‘×™×—×¡ ×œ×”××œ×¦×”.
  * ××•×ª×¨ ×œ×”×–×›×™×¨ trade-offs ×•××™-×•×“××•×ª.`;
}

async function callLLM(messages){
  if(!CONFIG.APPS_SCRIPT_URL) return getFallbackReply();
  // Always use JSONP but send only scenario index + condition + user messages
  // Server will build the full system prompt
  try{
    // Extract only user/assistant messages (not system prompt)
    const chatMsgs=messages.filter(m=>m.role!=='system');
    const compact={idx:ST.cur,cond:ST.cond,msgs:chatMsgs,model:CONFIG.MODEL};
    const payload=encodeURIComponent(JSON.stringify(compact));
    const cbName='cb_'+Date.now();
    return new Promise((resolve)=>{
      const timeout=setTimeout(()=>{resolve(getFallbackReply());cleanup()},20000);
      window[cbName]=function(data){clearTimeout(timeout);resolve(data.reply||getFallbackReply());cleanup()};
      function cleanup(){delete window[cbName];if(script.parentNode)script.parentNode.removeChild(script)}
      const script=document.createElement('script');
      script.src=CONFIG.APPS_SCRIPT_URL+'?callback='+cbName+'&payload='+payload;
      script.onerror=function(){clearTimeout(timeout);resolve(getFallbackReply());cleanup()};
      document.body.appendChild(script);
    });
  }catch(e){console.error('LLM error:',e);return getFallbackReply()}
}

function getFallbackReply(){return'××¤×©×¨ ×œ×‘×—×•×¨ ×›×©× ×•×— ×œ×š.'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveToSheets(row){
  if(!CONFIG.APPS_SCRIPT_URL)return{ok:false,reason:'no_url'};
  try{
    const lite={...row};
    delete lite.chat_logs;
    const payload=encodeURIComponent(JSON.stringify({save:1,data:lite}));
    const cbName='sv_'+Date.now();
    return new Promise((resolve)=>{
      const timeout=setTimeout(()=>{resolve({ok:false,reason:'timeout'});cleanup()},12000);
      window[cbName]=function(d){clearTimeout(timeout);resolve({ok:true});cleanup()};
      function cleanup(){delete window[cbName];if(s.parentNode)s.parentNode.removeChild(s)}
      const s=document.createElement('script');
      s.src=CONFIG.APPS_SCRIPT_URL+'?callback='+cbName+'&save=1&payload='+payload;
      s.onerror=function(){clearTimeout(timeout);resolve({ok:false,reason:'network'});cleanup()};
      document.body.appendChild(s);
    });
  }catch(e){return{ok:false,reason:e.message}}
}

// Save chat log for a single scenario (separate JSONP call)
async function saveChatLog(scenarioIdx, chatHistory){
  if(!CONFIG.APPS_SCRIPT_URL||!chatHistory||chatHistory.length===0)return;
  try{
    const logData={
      save:1, sheet:'ChatLogs',
      data:{
        run_id:RUN_ID,
        scenario:scenarioIdx+1,
        condition:ST.cond,
        timestamp:new Date().toISOString(),
        messages:chatHistory.map(m=>(m.r==='ai'?'×× ×”×œ: ':'××©×ª×ª×£: ')+m.t).join('\n')
      }
    };
    const payload=encodeURIComponent(JSON.stringify(logData));
    const cbName='cl_'+Date.now();
    const s=document.createElement('script');
    s.src=CONFIG.APPS_SCRIPT_URL+'?callback='+cbName+'&save=1&payload='+payload;
    window[cbName]=function(){delete window[cbName];if(s.parentNode)s.parentNode.removeChild(s)};
    setTimeout(()=>{delete window[cbName];if(s.parentNode)s.parentNode.removeChild(s)},10000);
    document.body.appendChild(s);
  }catch(e){console.log('Chat log save error:',e)}
}
function buildRow(){
  const rawTime=Math.round((ST.tEnd-ST.t0)/1000);
  let total=0;const sc={};
  for(let i=0;i<5;i++){const d=ST.D[`D${i+1}`]||'',s=d?SCENARIOS[i].score(d):0;sc[`TaskScore_D${i+1}`]=s;total+=s}
  const urlParam=(new URLSearchParams(location.search).get('condition')||'').toLowerCase();
  const condSource=urlParam==='random'?'random':urlParam?'url':'manual';
  const row={
    run_id:RUN_ID,
    timestamp:new Date().toISOString(),
    condition:ST.cond,condition_source:condSource,
    completion_status:'finished',
    last_step_reached:'done',
    started_at:new Date(ST.t0).toISOString(),
    ended_at:new Date(ST.tEnd).toISOString(),
    tz_offset:new Date().getTimezoneOffset(),
    D1:ST.D.D1||'',D2:ST.D.D2||'',D3:ST.D.D3||'',D4:ST.D.D4||'',D5:ST.D.D5||'',
    R1:ST.R.R1||'',R2:ST.R.R2||'',R3:ST.R.R3||'',R4:ST.R.R4||'',R5:ST.R.R5||'',
    C1:ST.C.C1||'',C2:ST.C.C2||'',C3:ST.C.C3||'',C4:ST.C.C4||'',C5:ST.C.C5||''};
  // Per-scenario timing
  for(let i=1;i<=5;i++){
    const ts=ST.ts[`S${i}`];
    row[`S${i}_duration_sec`]=ts&&ts.end?Math.round((ts.end-ts.start)/1000):'';
  }
  // Chat metrics
  const chatEnabled=(ST.cond==='B'||ST.cond==='C')?1:0;
  row.chat_enabled=chatEnabled;
  for(let i=1;i<=5;i++){
    const sKey=`S${i}`;
    row[`chat_msg_count_S${i}`]=ST.chatMsgCount[sKey]||0;
    const firstMsg=ST.chatFirstMsgTime[sKey];
    const scenEnd=ST.ts[sKey]&&ST.ts[sKey].end;
    row[`chat_time_S${i}`]=firstMsg&&scenEnd?Math.round((scenEnd-firstMsg)/1000):0;
  }
  Object.assign(row,sc);
  row.TotalScore=total;
  row.TotalScoreNorm=Math.round(total/50*1000)/10;
  row.TotalTimeSec=rawTime;
  row.MC_transparency=ST.MC.MC_transparency||'';
  row.MC_explainability=ST.MC.MC_explainability||'';
  row.MC_trust=ST.MC.MC_trust||'';
  row.attention_check=ST.MC.attention_check||'';
  // Device info (non-PII)
  const ua=navigator.userAgent;
  row.device_type=/Mobi|Android/i.test(ua)?'mobile':'desktop';
  row.browser=(/Chrome/.test(ua)&&!/Edg/.test(ua))?'Chrome':/Safari/.test(ua)&&!/Chrome/.test(ua)?'Safari':/Firefox/.test(ua)?'Firefox':/Edg/.test(ua)?'Edge':'other';
  row.chat_logs=JSON.stringify(ST.allChatLogs);
  return row;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE PERSISTENCE (survive page refresh)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(){window.scrollTo(0,0);({welcome:rWelcome,scenario:rScenario,likert1:rLikert1,likert2:rLikert2,manipCheck:rManipCheck,done:rDone})[ST.phase]?.()}

// â”€â”€â”€ Welcome â”€â”€â”€
function rWelcome(){
  const uc=getCond();if(uc)ST.cond=uc;
  app.innerHTML=`<div class="screen"><div class="card" style="text-align:center;padding:40px 32px">
    <div style="font-size:48px;margin-bottom:16px">ğŸ¢</div>
    <h1 style="margin-bottom:4px">×¡×™××•×œ×¦×™×™×ª ×§×‘×œ×ª ×”×—×œ×˜×•×ª × ×™×”×•×œ×™×•×ª</h1>
    <p style="color:var(--primary);font-weight:500;margin-bottom:24px">××—×§×¨ ×“×•×§×˜×•×¨×˜ â€” ××•× ×™×‘×¨×¡×™×˜×ª ××¨×™××œ</p>
    <div style="text-align:right;max-width:500px;margin:0 auto">
      <p>×©×œ×•×,</p>
      <p>××ª/×” ×¢×•××“/×ª ×œ×”×©×ª×ª×£ ×‘×¡×™××•×œ×¦×™×” ×©×œ ×§×‘×œ×ª ×”×—×œ×˜×•×ª × ×™×”×•×œ×™×•×ª.</p>
      <p>×‘×›×œ ×©×œ×‘ ×™×•×¦×’ ×ª×¨×—×™×©. ×× ×”×œ ×“×™×’×™×˜×œ×™ ×™×œ×•×•×” ××•×ª×š â€” ×ª×•×›×œ/×™ ×œ×©×•×—×— ××™×ª×• ×•×œ×©××•×œ ×©××œ×•×ª.</p>
      <p>×œ××—×¨ ×›×œ ×‘×—×™×¨×” ×ª×¢× ×”/×™ ×¢×œ ×©×ª×™ ×©××œ×•×ª ×§×¦×¨×•×ª.</p>
      <p style="color:var(--text);font-weight:500">×”×¡×™××•×œ×¦×™×” ×›×•×œ×œ×ª 5 ×ª×¨×—×™×©×™× ×•× ××©×›×ª ×›-10 ×“×§×•×ª.</p>
      <p style="color:var(--error);font-size:13px;background:var(--error-bg);padding:10px 14px;border-radius:8px;margin-top:8px">âš ï¸ ×©×™×/×™ ×œ×‘: ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ ××‘×•×¡×¡ ×¢×œ ×‘×™× ×” ××œ××›×•×ª×™×ª ×•×¢×©×•×™ ×œ×˜×¢×•×ª. ×”×”××œ×¦×•×ª ×©×œ×• ×”×Ÿ ×›×œ×™ ×¢×–×¨ ×‘×œ×‘×“ â€” ×”×”×—×œ×˜×” ×”×¡×•×¤×™×ª ×ª××™×“ ×©×œ×š.</p>
    </div>

    <div style="text-align:right;max-width:500px;margin:20px auto 0;padding:16px 20px;background:#f8f9fb;border-radius:10px;border:1px solid var(--border);font-size:13px;color:var(--text2);line-height:1.9">
      <b style="color:var(--text)">ğŸ”’ ×¤×¨×˜×™×•×ª ×•×”×¡×›××”</b><br>
      â€¢ ×”×”×©×ª×ª×¤×•×ª ×× ×•× ×™××™×ª â€” ×œ× × ××¡×£ ×©×, ××™××™×™×œ, ××• ××™×“×¢ ××–×”×”.<br>
      â€¢ ×”× ×ª×•× ×™× ×©× ×©××¨×™×: ×‘×—×™×¨×•×ª, ×–×× ×™×, ×“×™×¨×•×’×™× ×•×ª×•×›×Ÿ ×”×©×™×— ×¢× ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ â€” ×”×›×œ ×‘××•×¤×Ÿ ×× ×•× ×™××™.<br>
      â€¢ × × ×œ× ×œ×”×–×™×Ÿ ××™×“×¢ ××™×©×™ ××–×”×” (×©×, ×˜×œ×¤×•×Ÿ ×•×›×•') ×‘×©×™×—×” ×¢× ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™.<br>
      â€¢ ×—×œ×§ ××”×ª×¨×—×™×©×™× ×›×•×œ×œ×™× ×©×™×— ×¢× ××¢×¨×›×ª AI (GPT). ×ª×•×›×Ÿ ×”×©×™×— × ×©×œ×— ×œ×©×¨×ª OpenAI ×œ×¦×•×¨×š ×¢×™×‘×•×“.<br>
      â€¢ ×”× ×ª×•× ×™× ×™×©××©×• ×œ××—×§×¨ ××§×“××™ ×‘×œ×‘×“ ×•×œ× ×™×•×¢×‘×¨×• ×œ×¦×“ ×©×œ×™×©×™.<br>
      â€¢ ×™×™×ª×›×Ÿ ×©×—×œ×§ ××”××™×“×¢ ×©×™×•×¦×’ ×œ× ×™×©×§×£ ××ª ×”×¤×ª×¨×•×Ÿ ×”××•×¤×˜×™××œ×™ â€” ×–×”×• ×—×œ×§ ××¢×™×¦×•×‘ ×”××—×§×¨.<br>
      <div style="margin-top:10px">
        <label style="cursor:pointer;font-size:14px;color:var(--text);display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="consentCheck" style="width:18px;height:18px;cursor:pointer">
          <span>×§×¨××ª×™ ×•×”×‘× ×ª×™ â€” ×× ×™ ××¡×›×™×/×” ×œ×”×©×ª×ª×£</span>
        </label>
      </div>
    </div>
    ${uc?'':`<div style="margin-top:24px;padding:16px;background:#fff8e1;border-radius:10px;border:1px solid #ffe082">
      <p style="font-size:13px;color:#6d4c00;margin:0"><b>××¦×‘ ×‘×“×™×§×”</b> â€” ×‘×—×¨/×™ ×ª× ××™ × ×™×¡×•×™×™:</p>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-secondary" style="flex:1;margin:0;font-size:13px;padding:10px" onclick="ST.cond='A';$('startBtn').style.display='block'">A â€“ × ×™×˜×¨×œ×™</button>
        <button class="btn btn-secondary" style="flex:1;margin:0;font-size:13px;padding:10px" onclick="ST.cond='B';$('startBtn').style.display='block'">B â€“ ×§×•×¤×¡×” ×©×—×•×¨×”</button>
        <button class="btn btn-secondary" style="flex:1;margin:0;font-size:13px;padding:10px" onclick="ST.cond='C';$('startBtn').style.display='block'">C â€“ XAI</button>
      </div>
    </div>`}
    <button class="btn btn-primary" id="startBtn" style="${uc?'':'display:none;'}margin-top:24px;max-width:300px;margin-left:auto;margin-right:auto" onclick="doStart()">â–¶ï¸ ×œ×”×ª×—×™×œ</button>
  </div></div>`;
}

function doStart(){
  if(!ST.cond)return;
  const cb=$('consentCheck');
  if(cb&&!cb.checked){cb.parentElement.style.color='var(--error)';cb.focus();return}
  ST.t0=Date.now();ST.cur=0;ST.ts.S1={start:Date.now()};ST.phase='scenario';ST.chatHistory=[];ST.chatRounds=0;ST.choiceMade=false;go()
}

// â”€â”€â”€ Scenario (with chat) â”€â”€â”€
async function rScenario(){
  const i=ST.cur, s=SCENARIOS[i];
  ST.chatHistory=[];ST.chatRounds=0;ST.choiceMade=false;

  const hasAI = ST.cond==='B'||ST.cond==='C';

  app.innerHTML=`<div class="screen">${pBar()}<div class="layout with-chat"><div class="card scenario-card">
    <span class="scenario-badge">×ª×¨×—×™×© ${i+1} ××ª×•×š 5</span>
    <h2>${s.title}</h2>
    <div class="bg-text">${s.background}</div>
    <div class="table-wrap">${s.tableHTML}</div>
    <div class="legend">${s.legend}</div>
    <div class="task-text">ğŸ“‹ ××©×™××”: ${s.task}</div>
    <div class="options-text">${s.validOptions}</div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="chat-header">
      <div class="avatar">${hasAI?'ğŸ¤–':'ğŸ’¬'}</div>
      <div><div class="name">${hasAI?'×”×× ×”×œ ×”×“×™×’×™×˜×œ×™':'×ª×™×‘×ª ×”×—×œ×˜×”'}</div><div class="status">${hasAI?'××§×•×•×Ÿ':''}</div></div>
    </div>
    <div class="chat-messages" id="chatMsgs">
      ${hasAI?'<div class="typing" id="typing"><span></span><span></span><span></span></div>':''}
    </div>
    ${hasAI?`<div class="rounds-left" id="roundsLeft"></div>`:''}
    <div class="chat-input" id="chatInput" style="${hasAI?'display:none':'display:flex'}">
      <input id="chatText" placeholder="${hasAI?'×©××œ/×™ ×©××œ×” ××• ×”×–×Ÿ/×™ ×‘×—×™×¨×”...':(s.placeholder||'×”×–×Ÿ/×™ ×‘×—×™×¨×”...')}" onkeydown="if(event.key==='Enter')handleChatSubmit()">
      <button onclick="handleChatSubmit()">×©×œ×—</button>
    </div>
  </div>

  </div></div>`;

  // Condition A: show instruction in chat
  if(!hasAI){
    addChatBubble('ğŸ“‹ ' + s.inputLabel,'system');
  }

  // Conditions B/C: generate initial AI message
  if(hasAI){
    const msgs=buildLLMMessages(i, 'initial');
    const reply = await callLLM(msgs);
    ST.chatHistory.push({role:'assistant',content:reply});
    const typingEl=$('typing');
    if(typingEl)typingEl.remove();
    addChatBubble(reply,'ai');
    addChatBubble('×›×“×™ ×œ×‘×—×•×¨: ' + s.inputLabel,'system');
    $('chatInput').style.display='flex';
    updateRoundsLeft();
  }

  // RTL/LTR auto-detect for mixed input (Hebrew questions + English/number choices)
  const it=$('chatText');
  if(it){
    const syncDir=()=>{
      const v=(it.value||'').trim();
      const isLTR=/^[0-9A-Za-z]/.test(v);
      it.style.direction=isLTR?'ltr':'rtl';
      it.style.textAlign=isLTR?'left':'right';
    };
    it.addEventListener('input',syncDir);
    it.addEventListener('focus',syncDir);
    syncDir();
  }
}

function buildLLMMessages(idx, type, userMsg=''){
  const s=SCENARIOS[idx];
  const sys={role:'system',content:sysPrompt(idx)};
  if(type==='initial'){
    const condPrompt = ST.cond==='B'
      ? `×›×ª×•×‘/×›×ª×‘×™ ×‘×“×™×•×§ 2 ××©×¤×˜×™×, ×©×™×—×ª×™×™×:
1) "×× ×™ ×××œ×™×¥/×” ×¢×œ: ${s.llmRec}."
2) ×©××œ×ª ×¡×’×™×¨×” ×©××—×“×“×ª ×§×¨×™×˜×¨×™×•×Ÿ (×œ××©×œ: "××” ×™×•×ª×¨ ×—×©×•×‘ ×œ×š ×¢×›×©×™×•: ___ ××• ___?").
×‘×œ×™ × ×™××•×§×™×, ×‘×œ×™ ×¨×©×™××•×ª, ×•×‘×œ×™ × ×™×¡×•×—×™× ×’× ×¨×™×™× ×›××• "×× ×™ ×›××Ÿ ×œ×¡×™×™×¢".
×‘×”×•×“×¢×•×ª ×”××©×š: ××œ ×ª×—×–×•×¨/×™ ×¢×œ ×©× ×™ ×”××©×¤×˜×™× ×”×¨××©×•× ×™×; ×¢× ×”/×™ ×œ×©××œ×” ×‘×œ×‘×“.`
      : `×›×ª×•×‘/×›×ª×‘×™ ×¢×“ 3 ××©×¤×˜×™×, ×©×™×—×ª×™×™×:
1) "×× ×™ ×××œ×™×¥/×” ×¢×œ: ${s.llmRec}."
2) ×©×™×§×•×œ-×©× ×™×™× ×‘××™×œ×™× ×¤×©×•×˜×•×ª (×‘×œ×™ ×¨×©×™××•×ª ×•×‘×œ×™ ×œ×—×–×•×¨ ×¢×œ ×›×œ ×”× ×ª×•× ×™×).
3) ××©×¤×˜ ×§×¦×¨ ×©×œ ××™-×•×“××•×ª + ×©××œ×ª ×¡×’×™×¨×” ("××” ×™×•×ª×¨ ×—×©×•×‘ ×œ×š ×¢×›×©×™×•: ___ ××• ___?").
×‘×œ×™ ×›×•×ª×¨×•×ª/×‘×•×œ×˜×™×/×¤×•×¨××˜ ×“×•×—, ×•×‘×œ×™ "×× ×™ ×›××Ÿ ×œ×¡×™×™×¢".
×‘×”×•×“×¢×•×ª ×”××©×š: ××œ ×ª×—×–×•×¨/×™ ×¢×œ ×”×”×•×“×¢×” ×”×¨××©×•× ×”; ×¢× ×”/×™ ×œ×©××œ×” ×‘×œ×‘×“.`;
    return [sys, {role:'user',content:condPrompt}];
  }
  // Follow-up
  const history = ST.chatHistory.map(m=>({role:m.role,content:m.content}));
  const payload = followupStyle() + "\n\n×©××œ×ª ×”××©×ª×ª×£: " + normalizeUserForLLM(userMsg);
  return [sys, ...history, {role:'user',content:payload}];
}

// Unified handler: detect if input is a choice or a question
function handleChatSubmit(){
  const input=$('chatText');
  const txt=input.value.trim();
  if(!txt)return;

  const i=ST.cur, s=SCENARIOS[i];
  const hasAI=ST.cond==='B'||ST.cond==='C';

  // Try to validate as a choice
  const validated=s.validate(txt);

  if(validated!==null){
    // It's a valid choice â€” submit it
    addChatBubble(txt,'user');
    input.value='';
    ST.D[s.dKey]=validated;

    // Save chat logs
    if(ST.chatHistory.length>0){
      ST.allChatLogs[`S${i+1}`]=ST.chatHistory.map(m=>({r:m.role==='assistant'?'ai':'user',t:m.content.substring(0,300)}));
    }

    // Confirmation
    if(hasAI){
      if($('chatInput'))$('chatInput').style.display='none';
      addChatBubble('×”×‘×—×™×¨×” × ×§×œ×˜×”. ×ª×•×“×”.','ai');
      if(ST.cond==='C'&&s.microExplanation){
        addChatBubble(s.microExplanation,'ai');
      }
    }else{
      if($('chatInput'))$('chatInput').style.display='none';
      addChatBubble('âœ… ×”×‘×—×™×¨×” × ×§×œ×˜×”.','system');
    }
    setTimeout(()=>{ST.phase='likert1';go()},800);
  } else if(hasAI && ST.chatRounds<CONFIG.MAX_CHAT_ROUNDS){
    // It's a question â€” send to AI
    sendChat();
  } else if(!hasAI){
    // Condition A â€” invalid choice
    addChatBubble(txt,'user');
    input.value='';
    addChatBubble('âŒ ' + s.inputLabel,'system');
  } else {
    // B/C but out of rounds â€” must be a choice attempt
    addChatBubble(txt,'user');
    input.value='';
    addChatBubble('âŒ ×”×§×œ×˜ ×œ× ×ª×§×™×Ÿ. ' + s.inputLabel,'system');
  }
}

async function sendChat(){
  const input=$('chatText');
  const txt=input.value.trim();
  if(!txt||ST.chatRounds>=CONFIG.MAX_CHAT_ROUNDS)return;

  // Track chat metrics
  const sKey=`S${ST.cur+1}`;
  if(!ST.chatMsgCount[sKey])ST.chatMsgCount[sKey]=0;
  ST.chatMsgCount[sKey]++;
  if(!ST.chatFirstMsgTime[sKey])ST.chatFirstMsgTime[sKey]=Date.now();

  addChatBubble(txt,'user');
  ST.chatHistory.push({role:'user',content:txt});
  input.value='';
  ST.chatRounds++;

  // Show typing
  const msgArea=$('chatMsgs');
  const typingEl=document.createElement('div');
  typingEl.className='typing';typingEl.id='typing2';
  typingEl.innerHTML='<span></span><span></span><span></span>';
  msgArea.appendChild(typingEl);
  msgArea.scrollTop=msgArea.scrollHeight;

  const msgs=buildLLMMessages(ST.cur,'followup',txt);
  const reply=await callLLM(msgs);
  ST.chatHistory.push({role:'assistant',content:reply});

  typingEl.remove();
  addChatBubble(reply,'ai');
  updateRoundsLeft();

  if(ST.chatRounds>=CONFIG.MAX_CHAT_ROUNDS){
    addChatBubble('×”×’×¢×ª ×œ××›×¡×ª ×”×©××œ×•×ª. ×”×–×Ÿ/×™ ××ª ×‘×—×™×¨×ª×š.','system');
  }
}

function addChatBubble(text,type){
  const msgArea=$('chatMsgs');
  const div=document.createElement('div');
  div.className=`msg ${type}`;
  div.textContent=text;
  msgArea.appendChild(div);
  msgArea.scrollTop=msgArea.scrollHeight;
}

function updateRoundsLeft(){
  const el=$('roundsLeft');
  if(!el)return;
  const left=CONFIG.MAX_CHAT_ROUNDS-ST.chatRounds;
  el.textContent=left>0?`${left} ×©××œ×•×ª × ×•×ª×¨×•`:'';
}

function doSubmit(){
  // Legacy â€” redirects to handleChatSubmit
  handleChatSubmit();
}

// â”€â”€â”€ Likert â”€â”€â”€
function rLikert1(){
  const i=ST.cur;
  // Condition A: no AI â†’ different wording
  const qText = ST.cond==='A'
    ? '×¢×“ ×›××” ×”×¡×ª××›×ª ×¢×œ ××™×“×¢ ×—×™×¦×•× ×™ (××¢×‘×¨ ×œ× ×ª×•× ×™× ×©×”×•×¦×’×•) ×‘×§×‘×œ×ª ×”×”×—×œ×˜×”?'
    : '×¢×“ ×›××” ×”×¡×ª××›×ª ×¢×œ ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ ×‘×§×‘×œ×ª ×”×”×—×œ×˜×”?';
  app.innerHTML=`<div class="screen">${pBar()}<div class="card">
    <span class="scenario-badge">×ª×¨×—×™×© ${i+1} â€” ×©××œ×” 1 ××ª×•×š 2</span>
    <div class="likert-q">${qText}</div>
    <div class="likert-scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="r" value="${n}" onchange="doR(${n})"><span class="lk">${n}</span></label>`).join('')}</div>
    <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
  </div></div>`;
}
function doR(v){ST.R[`R${ST.cur+1}`]=v;setTimeout(()=>{ST.phase='likert2';go()},200)}

function rLikert2(){
  const i=ST.cur;
  app.innerHTML=`<div class="screen">${pBar()}<div class="card">
    <span class="scenario-badge">×ª×¨×—×™×© ${i+1} â€” ×©××œ×” 2 ××ª×•×š 2</span>
    <div class="likert-q">×¢×“ ×›××” ××ª/×” ×‘×˜×•×—/×” ×‘×”×—×œ×˜×” ×©×§×™×‘×œ×ª?</div>
    <div class="likert-scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="c" value="${n}" onchange="doC(${n})"><span class="lk">${n}</span></label>`).join('')}</div>
    <div class="likert-anchors"><span>×‘×›×œ×œ ×œ× ×‘×˜×•×—/×”</span><span>×‘×˜×•×—/×” ×××•×“</span></div>
  </div></div>`;
}
function doC(v){
  const i=ST.cur;ST.C[`C${i+1}`]=v;ST.ts[`S${i+1}`].end=Date.now();
  // Save chat log only if user had actual interaction (not just choice)
  const sKey=`S${i+1}`;
  if(ST.allChatLogs[sKey]&&ST.allChatLogs[sKey].length>0&&ST.chatMsgCount[sKey]>0){
    saveChatLog(i, ST.allChatLogs[sKey]);
  }
  setTimeout(()=>{if(i<4){ST.cur=i+1;ST.ts[`S${i+2}`]={start:Date.now()};ST.phase='scenario'}else{ST.tEnd=Date.now();ST.phase='manipCheck'}go()},200);
}

// â”€â”€â”€ Manipulation Check (3 questions after all scenarios) â”€â”€â”€
function rManipCheck(){
  app.innerHTML=`<div class="screen">
    <div class="progress-bar">${[0,1,2,3,4].map(()=>'<div class="progress-step done"></div>').join('')}</div>
    <div class="card">
      <h2>×©××œ×•×ª ×¡×™×•×</h2>
      <p>×›××¢×˜ ×¡×™×™×× ×• â€” ×¢×•×“ 3 ×©××œ×•×ª ×§×¦×¨×•×ª ×¢×œ ×”×—×•×•×™×” ×”×›×œ×œ×™×ª.</p>

      <div style="margin:24px 0">
        <div class="likert-q">1. ×¢×“ ×›××” ×”×¨×’×©×ª ×©×”××™×“×¢ ×©×§×™×‘×œ×ª ×”×™×” ×©×§×•×£ ×•××•×‘×Ÿ?</div>
        <div class="likert-scale" id="mc1Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="mc1" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
        <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
      </div>

      <div style="margin:24px 0">
        <div class="likert-q">2. ×¢×“ ×›××” ×”×¨×’×©×ª ×©×”×”××œ×¦×•×ª ×©×§×™×‘×œ×ª ×”×™×• ×× ×•××§×•×ª ×•××•×¡×‘×¨×•×ª?</div>
        <div class="likert-scale" id="mc2Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="mc2" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
        <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
      </div>

      <div style="margin:24px 0">
        <div class="likert-q">3. ×¢×“ ×›××” ××ª/×” ×¡×•××›/×ª ×¢×œ ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ ×©×œ×™×•×•×” ××•×ª×š?</div>
        <div class="likert-scale" id="mc3Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="mc3" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
        <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
      </div>

      <div style="margin:24px 0;padding:16px 20px;background:#f8f9fb;border-radius:10px;border:1px solid var(--border)">
        <div class="likert-q">4. ×œ×¦×•×¨×š ×‘×§×¨×ª ××™×›×•×ª â€” ×× × ×¡××Ÿ/×™ ××ª ×”××¡×¤×¨ 4.</div>
        <div class="likert-scale" id="mc4Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="attn" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
      </div>

      <div class="error-msg" id="mcErr"></div>
      <button class="btn btn-primary" onclick="submitManipCheck()">×¡×™×•× âœ“</button>
    </div></div>`;
}

function submitManipCheck(){
  const mc1=document.querySelector('input[name="mc1"]:checked');
  const mc2=document.querySelector('input[name="mc2"]:checked');
  const mc3=document.querySelector('input[name="mc3"]:checked');
  const attn=document.querySelector('input[name="attn"]:checked');
  if(!mc1||!mc2||!mc3||!attn){$('mcErr').textContent='× × ×œ×¢× ×•×ª ×¢×œ ×›×œ ×”×©××œ×•×ª.';$('mcErr').classList.add('show');return}
  ST.MC={MC_transparency:+mc1.value, MC_explainability:+mc2.value, MC_trust:+mc3.value, attention_check:+attn.value===4?'pass':'fail'};
  ST.phase='done';go();
}

// â”€â”€â”€ Done â”€â”€â”€
async function rDone(){
  const rawTime=Math.round((ST.tEnd-ST.t0)/1000);
  app.innerHTML=`<div class="screen">
    <div class="progress-bar">${[0,1,2,3,4].map(()=>'<div class="progress-step done"></div>').join('')}</div>
    <div class="card" style="text-align:center;padding:40px 32px">
      <div style="font-size:48px;margin-bottom:16px">ğŸ‰</div>
      <h2>×”×¡×™××•×œ×¦×™×” ×”×¡×ª×™×™××”!</h2>
      <p style="margin-top:12px">×›×œ ×”×ª×©×•×‘×•×ª, ×”×–×× ×™× ×•×”×“×™×¨×•×’×™× × ×©××¨×• ××•×˜×•××˜×™×ª.</p>
      <div class="saving-status" id="ss" style="font-size:15px;margin:20px 0">â³ ×©×•××¨ × ×ª×•× ×™×...</div>
      <p style="font-size:14px;color:var(--text2)">×–××Ÿ ×›×•×œ×œ: ${rawTime} ×©× ×™×•×ª Â· ×§×‘×•×¦×”: ${ST.cond}</p>
      <br><p style="font-size:18px;color:var(--text)">×ª×•×“×” ×¨×‘×” ×¢×œ ×”×”×©×ª×ª×¤×•×ª! ğŸ™</p>
    </div></div>`;
  const res=await saveToSheets(buildRow());const el=$('ss');
  if(res.ok){el.innerHTML='âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”';el.style.color='var(--success)'}
  else if(res.reason==='no_url'){el.innerHTML='âš ï¸ ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ× ×”×•×’×“×¨×”';el.style.color='#e68a00'}
  else{el.innerHTML='âš ï¸ ××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×” â€” × × ×œ×¤× ×•×ª ×œ×—×•×§×¨/×ª';el.style.color='var(--error)'}
}

function doCopy(){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
go();
</script>
</body>
</html>
