<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>×¡×™××•×œ×¦×™×™×ª ×× ×”×œ ×“×™×’×™×˜×œ×™</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap');
  :root {
    --bg:#f5f6fa;--card:#fff;--primary:#2d5be3;--primary-light:#e8edfb;
    --primary-dark:#1a3fa0;--text:#1e2a3a;--text2:#5a6a7e;--border:#dfe3eb;
    --success:#22a06b;--success-bg:#e3fcef;--error:#de350b;--error-bg:#ffebe6;
    --ai-bg:#f0f4ff;--ai-border:#5b8def;--user-bg:#e8edfb;
    --shadow:0 2px 12px rgba(0,0,0,.06);--radius:12px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Rubik',sans-serif;background:var(--bg);color:var(--text);line-height:1.7;min-height:100vh}
  .container{max-width:1120px;margin:0 auto;padding:28px 22px 60px}

  /* Progress */
  .progress-bar{display:flex;gap:6px;margin-bottom:28px}
  .progress-step{flex:1;height:6px;border-radius:3px;background:var(--border);transition:background .4s}
  .progress-step.done{background:var(--success)}.progress-step.active{background:var(--primary)}

  /* Card */
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:32px 30px 28px;margin-bottom:20px;border:1px solid var(--border)}
  .scenario-badge{display:inline-block;background:var(--primary);color:#fff;font-size:13px;font-weight:600;padding:5px 16px;border-radius:20px;margin-bottom:16px}
  h1{font-size:26px;font-weight:700;margin-bottom:10px}
  h2{font-size:21px;font-weight:600;margin-bottom:14px}
  p,li{font-size:15px;color:var(--text2);margin-bottom:10px;line-height:1.8}
  .bg-text{font-size:15px;color:var(--text);background:#f8f9fb;padding:16px 20px;border-radius:10px;border-right:4px solid var(--primary-light);margin-bottom:18px;line-height:1.9}

  /* Table */
  table{width:100%;border-collapse:collapse;margin:18px 0;font-size:14px;border-radius:14px;overflow:hidden;border:1px solid var(--border)}
  th{background:#f7f9ff;color:var(--primary-dark);font-weight:600;padding:12px 14px;text-align:right;border-bottom:2px solid var(--primary);font-size:12px;letter-spacing:.02em}
  td{padding:12px 14px;border-bottom:1px solid var(--border);text-align:right;font-size:14px;transition:background .15s ease}
  .table-wrap{border-radius:14px;overflow:auto;-webkit-overflow-scrolling:touch}
  .table-wrap thead th{position:sticky;top:0;z-index:2;background:#f7f9ff;box-shadow:0 1px 0 rgba(0,0,0,.06)}
  .table-wrap tbody tr:nth-child(odd) td{background:#fcfdff}
  .table-wrap tbody tr:hover td{background:#f2f5ff}
  .table-wrap td+td,.table-wrap th+th{border-left:1px solid #eef1f6}
  .legend{font-size:13px;color:var(--text2);background:#f8f9fb;padding:10px 14px;border-radius:8px;margin:12px 0}
  .task-text{font-size:16px;font-weight:600;color:var(--text);margin:16px 0 8px}
  .options-text{font-size:14px;color:var(--text2);font-style:italic}

  /* Chat */
  .chat-area{margin:20px 0;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.04)}
  .chat-header{background:var(--ai-bg);padding:14px 20px;border-bottom:1px solid var(--ai-border);display:flex;align-items:center;gap:12px}
  .chat-header .avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;box-shadow:0 2px 6px rgba(45,91,227,.3)}
  .chat-header .name{font-weight:600;font-size:15px;color:var(--primary-dark)}
  .chat-header .status{font-size:12px;color:var(--ai-border)}
  .chat-messages{padding:20px;min-height:120px;max-height:450px;overflow-y:auto;background:#fafbfd;display:flex;flex-direction:column;gap:14px}
  .msg{max-width:82%;padding:14px 18px;border-radius:16px;font-size:14.5px;line-height:1.8;white-space:pre-wrap;animation:msgIn .3s ease-out}
  @keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .msg.ai{background:var(--ai-bg);border:1px solid var(--ai-border);align-self:flex-start;border-top-right-radius:4px}
  .msg.user{background:var(--user-bg);border:1px solid var(--primary-light);align-self:flex-end;border-top-left-radius:4px;color:var(--text)}
  .msg.system{background:#fff8e1;border:1px solid #ffe082;align-self:center;text-align:center;font-size:13px;color:#6d4c00;max-width:90%;border-radius:10px}
  .typing{display:flex;align-items:center;gap:4px;padding:8px 16px;align-self:flex-start}
  .typing span{width:7px;height:7px;background:var(--ai-border);border-radius:50%;animation:blink 1.2s infinite}
  .typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  .chat-input{display:flex;gap:10px;padding:14px 18px;padding-bottom:calc(14px + env(safe-area-inset-bottom));border-top:1px solid var(--border);background:#fff}
  .chat-input input{flex:1;padding:11px 16px;font-size:15px;font-family:'Rubik',sans-serif;border:1.5px solid var(--border);border-radius:10px;outline:none;transition:border .2s}
  .chat-input input:focus{border-color:var(--primary)}
  .chat-input button{padding:11px 24px;font-size:14px;font-weight:600;font-family:'Rubik',sans-serif;background:var(--primary);color:#fff;border:none;border-radius:10px;cursor:pointer;transition:background .2s;white-space:nowrap}
  .chat-input button:hover{background:var(--primary-dark)}
  .chat-input button:disabled{background:#b0bec5;cursor:not-allowed}

  /* Choice input */
  .choice-section{margin:20px 0;padding:20px;background:#f8f9fb;border-radius:var(--radius);border:1px solid var(--border)}
  .choice-section label{display:block;font-weight:600;font-size:15px;margin-bottom:8px}
  .choice-section input[type="text"]{width:100%;padding:12px 16px;font-size:18px;font-family:'Rubik',sans-serif;border:2px solid var(--border);border-radius:8px;direction:ltr;text-align:center;letter-spacing:2px;outline:none;transition:border .2s}
  .choice-section input:focus{border-color:var(--primary)}
  .error-msg{background:var(--error-bg);color:var(--error);padding:10px 16px;border-radius:8px;font-size:14px;margin:10px 0;display:none}
  .error-msg.show{display:block}

  /* Buttons */
  .btn{display:block;width:100%;padding:14px;font-size:16px;font-weight:600;font-family:'Rubik',sans-serif;border:none;border-radius:10px;cursor:pointer;transition:all .2s;margin-top:12px}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-primary:hover{background:var(--primary-dark)}.btn-primary:active{transform:scale(.98)}
  .btn-primary:disabled{background:#b0bec5;cursor:not-allowed}
  .btn-secondary{background:transparent;color:var(--primary);border:2px solid var(--primary)}
  .btn-secondary:hover{background:var(--primary-light)}

  /* Likert */
  .likert-q{font-size:16px;font-weight:600;margin-bottom:12px;color:var(--text)}
  .likert-scale{display:flex;justify-content:space-between;gap:6px;margin:16px 0}
  .likert-scale label{flex:1;text-align:center;cursor:pointer}
  .likert-scale input[type="radio"]{display:none}
  .likert-scale .lk{display:block;padding:12px 0;font-size:18px;font-weight:600;border:2px solid var(--border);border-radius:10px;transition:all .15s;color:var(--text2)}
  .likert-scale input:checked+.lk{background:var(--primary);color:#fff;border-color:var(--primary);transform:scale(1.05)}
  .likert-scale label:hover .lk{border-color:var(--primary);color:var(--primary)}
  .likert-anchors{display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-top:-6px}

  /* Completion */
  .completion-box{background:var(--success-bg);border:2px solid var(--success);border-radius:var(--radius);padding:28px;text-align:center;margin:20px 0}
  .confirm-msg{background:var(--success-bg);color:var(--success);padding:12px 18px;border-radius:8px;font-weight:600;font-size:15px;margin:16px 0}
  .micro-explain{font-size:14px;color:var(--text2);font-style:italic;margin:8px 0 16px}
  .saving-status{font-size:13px;color:var(--text2);text-align:center;margin-top:8px}
  .screen{animation:fadeIn .35s ease-out}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .rounds-left{font-size:12px;color:var(--text2);text-align:center;padding:4px}

  /* Responsive layout */
  .layout{display:grid;gap:18px;align-items:start}
  .layout.with-chat{grid-template-columns:1fr;grid-template-areas:
    "scenario"
    "chat";}
  .layout.no-chat{grid-template-columns:1fr;grid-template-areas:
    "scenario";}
  .scenario-card{grid-area:scenario}
  .chat-area{grid-area:chat}

  /* Tables: scroll on small screens */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:10px 0;border-radius:8px}
  .table-wrap table{min-width:520px;margin:0}
  th,td{padding:10px 10px;font-size:13px;white-space:nowrap}

  /* Compact cards */
  .card{padding:26px 24px 22px}
  .bg-text{padding:14px 16px;margin-bottom:14px}
  .legend{margin:10px 0}
  .scenario-badge{margin-bottom:10px;padding:4px 12px;font-size:12px;opacity:.95}
  h2{margin-bottom:10px}

  /* Pills for table values */
  .pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 10px;border-radius:999px;font-weight:700;font-size:12px;line-height:1;border:1px solid var(--border);background:#fff;color:var(--text)}
  .pill.u5{background:var(--error-bg);border-color:#ffbdad;color:var(--error)}
  .pill.u4{background:#fff4e5;border-color:#ffd8a8;color:#9c6f00}
  .pill.u3{background:#fff4e5;border-color:#ffd8a8;color:#9c6f00}
  .pill.u2{background:#e3fcef;border-color:#abf5d1;color:#006644}
  .pill.u1{background:#f1f3f5;border-color:#e9ecef;color:#495057}

  /* Desktop: chat on the side */
  @media (min-width: 1024px){
    .layout.with-chat{
      grid-template-columns:420px minmax(0,1fr);
      grid-template-areas:"chat scenario";
      align-items:start;
    }
    .chat-area{position:sticky;top:18px}
    .chat-messages{max-height:min(560px, calc(100vh - 260px))}
  }

  /* Tablet & Mobile */
  @media (max-width: 700px){
    .container{padding:12px 8px 40px}
    .card{padding:18px 14px}
    h1{font-size:20px}
    h2{font-size:17px}
    .bg-text{padding:12px 12px;font-size:14px}
    .table-wrap table{min-width:640px}
    th,td{padding:8px 6px;font-size:12px}
    .chat-area{border-radius:10px}
    .chat-messages{padding:12px;max-height:320px;min-height:100px}
    .msg{max-width:90%;font-size:13.5px;padding:11px 14px}
    .chat-input{padding:10px 12px}
    .chat-input input{font-size:16px;padding:10px 12px}
    .chat-input button{padding:10px 16px;font-size:14px}
    .likert-scale{gap:4px}
    .likert-scale .lk{font-size:15px;min-width:36px;min-height:36px}
    .scenario-badge{font-size:11px;padding:3px 10px}
    .task-text{font-size:14px}
    .options-text{font-size:13px}
    .legend{font-size:12px;padding:8px 10px}
    .pill{font-size:11px;padding:2px 8px}
    .progress-bar{margin-bottom:16px}
  }

  @media (max-width: 380px){
    .container{padding:8px 6px 36px}
    .card{padding:14px 10px}
    .chat-header{padding:10px 12px}
    .chat-header .avatar{width:32px;height:32px;font-size:16px}
    .chat-header .name{font-size:14px}
    .btn{font-size:14px;padding:12px 18px}
    th,td{padding:6px 4px;font-size:11px}
    .msg{max-width:94%;font-size:13px;padding:10px 12px}
  }

  /* â”€â”€ Premium touches â”€â”€ */
  body{
    background:
      radial-gradient(900px 520px at 85% -10%, rgba(45,91,227,.10), transparent 60%),
      radial-gradient(820px 520px at -10% 20%, rgba(34,160,107,.08), transparent 55%),
      var(--bg);
  }
  .card{position:relative;overflow:hidden}
  .card::before{
    content:"";position:absolute;left:0;right:0;top:0;
    height:3px;background:linear-gradient(90deg,var(--primary),#6f8cff);opacity:.9;
  }
  button,.btn{box-shadow:0 6px 16px rgba(45,91,227,.18)}
  button:hover,.btn:hover{transform:translateY(-1px)}
  button:active,.btn:active{transform:translateY(0);box-shadow:0 3px 10px rgba(45,91,227,.14)}
  :focus-visible{outline:3px solid rgba(45,91,227,.35);outline-offset:2px;border-radius:10px}
  .chat-input input:focus{box-shadow:0 0 0 4px rgba(45,91,227,.12)}
  .table-wrap thead th{position:sticky;top:0;z-index:2}
  td{transition:background .15s ease}
  tr:hover td{background:#f2f5ff}
  .msg{box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .msg.ai{box-shadow:0 2px 12px rgba(45,91,227,.08)}
  .msg.user{box-shadow:0 2px 12px rgba(45,91,227,.06)}
</style>
</head>
<body>
<div class="container" id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// *** CONFIGURATION ***
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwe7lF2jBBTLf1nI72bs6tl-sCTq7MoF4NTva_qsvmY_WrIsiyAGos2cqrdd4DD0rHieA/exec',
  MODEL: 'gpt-4o-mini',      // gpt-4o-mini (~$0.01/participant) or gpt-4o
  MAX_CHAT_ROUNDS: 5          // max follow-up questions per scenario
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENARIOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCENARIOS = [
  // â”€â”€ 1 â”€â”€
  { title:"×ª×¢×“×•×£ ×¤× ×™×•×ª ×œ×§×•×—×•×ª", dKey:"D1",
    background:"×‘×•×§×¨ ×™×•× ×¨××©×•×Ÿ, 08:00. ×™×© ×¢×•××¡ ×‘×¤×ª×™×—×ª ×”×©×‘×•×¢, ×•×‘-09:00 ×”×× ×”×œ ×”×™×©×™×¨ ××‘×§×© ×¢×“×›×•×Ÿ ××¦×‘. ×—×œ×§ ××”×¤× ×™×•×ª ×¨×’×™×©×•×ª ×œ× ×˜×™×©×”/×ª×¡×›×•×œ, ×•×—×œ×§×Ÿ ×¢×œ×•×œ×•×ª ×œ×”×¤×•×š ×œ×”×¡×œ××” ×ª×¤×¢×•×œ×™×ª ×× ×™×ª×¢×›×‘×•.",
    tableHTML:`<table><tr><th>#</th><th>×ª×™××•×¨</th><th>×“×—×™×¤×•×ª</th><th>××•×¨×›×‘×•×ª</th><th>×–××Ÿ ×˜×™×¤×•×œ</th><th>×œ×§×•×— (×©×‘"×¨)</th></tr>
<tr><td>1</td><td>×©××œ×” ×¢×œ ×—×™×•×‘</td><td><span class="pill u2">2/5</span></td><td>×§×œ</td><td>10 ×“×§'</td><td>×¨×’×™×œ (4/5)</td></tr>
<tr><td>2</td><td>××¢×¨×›×ª ×œ× × ×˜×¢× ×ª</td><td><span class="pill u5">5/5</span></td><td>×‘×™× ×•× ×™</td><td>30 ×“×§'</td><td>VIP (3/5)</td></tr>
<tr><td>3</td><td>×‘×§×©×ª ×¤×™×¦'×¨</td><td><span class="pill u1">1/5</span></td><td>×§×©×”</td><td>45 ×“×§'</td><td>×—×“×© (5/5)</td></tr>
<tr><td>4</td><td>×‘××’ â€“ ××•×‘×“×Ÿ ××™×“×¢</td><td><span class="pill u5">5/5</span></td><td>×§×©×”</td><td>60 ×“×§'</td><td>×•×ª×™×§ (2/5)</td></tr>
<tr><td>5</td><td>×©××œ×” ×˜×›× ×™×ª</td><td><span class="pill u3">3/5</span></td><td>×§×œ</td><td>15 ×“×§'</td><td>×¨×’×™×œ (4/5)</td></tr></table>`,
    legend:"×“×—×™×¤×•×ª 1-5 Â· ××•×¨×›×‘×•×ª: ×§×œ/×‘×™× ×•× ×™/×§×©×” Â· ×–××Ÿ ×˜×™×¤×•×œ: ×œ× ×¦×™×’ ×™×—×™×“ Â· ×©×‘\"×¨: ×¦×™×•×Ÿ ×œ×§×•×— (5 ×’×‘×•×”)",
    task:"×‘×—×¨/×™ 3 ×¤× ×™×•×ª ×œ×˜×™×¤×•×œ ××™×™×“×™.", validOptions:"5 ×¤× ×™×•×ª, 3 × ×¦×™×’×™× ×–××™× ×™× ×œ×©×¢×” ×”×§×¨×•×‘×”.",
    inputLabel:"×‘×—×¨/×™ 3 ×¤× ×™×•×ª (×œ××©×œ: 1,3,5 ××• 1 3 5)", placeholder:"×”×–×Ÿ/×™ 3 ××¡×¤×¨×™×",
    microExplanation:"×‘×”×—×œ×˜×•×ª ×ª×¢×“×•×£, ×”××¤×ª×— ×”×•× ×œ××–×Ÿ ×‘×™×Ÿ ×“×—×™×¤×•×ª ×ª×¤×¢×•×œ×™×ª ×œ× ×™×¦×•×œ ×™×¢×™×œ ×©×œ ×–××Ÿ ×”× ×¦×™×’×™×.",
    llmRec:"×¤× ×™×•×ª 2, 4 ×•-5",
    llmContext:`5 ×¤× ×™×•×ª ×œ×§×•×—×•×ª, 3 × ×¦×™×’×™× ×–××™× ×™× ×œ×©×¢×”.
1: ×—×™×•×‘, ×“×—×™×¤×•×ª 2/5, ×§×œ, 10×“×§', ×¨×’×™×œ 4/5.
2: ××¢×¨×›×ª ×œ× × ×˜×¢× ×ª, ×“×—×™×¤×•×ª 5/5, ×‘×™× ×•× ×™, 30×“×§', VIP 3/5.
3: ×‘×§×©×ª ×¤×™×¦'×¨, ×“×—×™×¤×•×ª 1/5, ×§×©×”, 45×“×§', ×—×“×© 5/5.
4: ×‘××’ ××•×‘×“×Ÿ ××™×“×¢, ×“×—×™×¤×•×ª 5/5, ×§×©×”, 60×“×§', ×•×ª×™×§ 2/5.
5: ×©××œ×” ×˜×›× ×™×ª, ×“×—×™×¤×•×ª 3/5, ×§×œ, 15×“×§', ×¨×’×™×œ 4/5.`,
    llmInstruction:`××ª×” × ×•×˜×” ×œ×›×™×•×•×Ÿ ×¤× ×™×•×ª 2, 4 ×•-5 ××‘×œ ××¡×•×¨ ×œ×š ×œ×•××¨ ×™×©×™×¨×•×ª ××” ×œ×‘×—×•×¨.
×©×™×§×•×œ×™× ×¤× ×™××™×™×: ×“×—×™×¤×•×ª+VIP=×¡×™×›×•×Ÿ × ×˜×™×©×”; ××•×‘×“×Ÿ ××™×“×¢=×¡×™×›×•×Ÿ ×××•×Ÿ; ×¤× ×™×™×” ××”×™×¨×”=××•×¨×™×“ ×¢×•××¡.
×”×›×•×•×Ÿ ××ª ×”××©×ª×ª×£: ×©××œ ×©××œ×•×ª ×¢×œ ×§×¨×™×˜×¨×™×•× ×™×, ×”×“×’×© × ×ª×•× ×™× ×‘×•×œ×˜×™×, ×¢×–×•×¨ ×œ×• ×œ×’×œ×•×ª ×‘×¢×¦××•.`,
    validate(v){const nums=v.match(/[1-5]/g);if(!nums||nums.length!==3)return null;return new Set(nums).size===3?nums.sort().join(''):null},
    score(d){const ch=new Set(d.split('')),op=new Set(['2','4','5']),mu=new Set(['2','4']);if(eq(ch,op))return 10;const ct=inter(ch,op).size,hm=sub(mu,ch);return ct===2&&hm?7:ct===2?6:ct===1?4:0}
  },
  // â”€â”€ 2 â”€â”€
  { title:"×‘×—×™×¨×ª \"×¢×•×‘×“ ×”×—×•×“×©\"", dKey:"D2",
    background:"×¡×•×£ ×—×•×“×©. ×¦×¨×™×š ×œ×‘×—×•×¨ \"×¢×•×‘×“ ×”×—×•×“×©\" ×¢×œ ×‘×¡×™×¡ × ×ª×•× ×™ ×‘×™×¦×•×¢. ×”×‘×—×™×¨×” ××©×¤×™×¢×” ×¢×œ ××•×˜×™×‘×¦×™×” ×•×ª×¤×™×¡×ª ×”×•×’× ×•×ª ×‘×¦×•×•×ª.",
    tableHTML:`<table><tr><th>×§×•×“</th><th>× ×¦×™×’/×”</th><th>×©×‘"×¨</th><th>×–××Ÿ ×ª×’×•×‘×”</th><th># ×¤× ×™×•×ª</th><th>××•×¨×›×‘×•×ª</th><th>×–××™× ×•×ª</th></tr>
<tr><td>R</td><td>×¨×•×¢×™</td><td>4.8/5</td><td>3 ×“×§'</td><td>180</td><td>45</td><td>20</td></tr>
<tr><td>S</td><td>×©×§×“</td><td>4.2/5</td><td>5 ×“×§'</td><td>220</td><td>30</td><td>22</td></tr>
<tr><td>Y</td><td>×™×¢×œ</td><td>4.9/5</td><td>2 ×“×§'</td><td>150</td><td>60</td><td>18</td></tr>
<tr><td>D</td><td>×“× ×™</td><td>4.0/5</td><td>6 ×“×§'</td><td>240</td><td>20</td><td>22</td></tr>
<tr><td>M</td><td>××™×”</td><td>4.5/5</td><td>4 ×“×§'</td><td>200</td><td>50</td><td>21</td></tr></table>`,
    legend:"×©×‘\"×¨: ×××•×¦×¢ ×—×•×“×©×™ Â· ×–××Ÿ ×ª×’×•×‘×”: ×“×§×•×ª Â· ××•×¨×›×‘×•×ª: ×¤× ×™×•×ª ×××ª×’×¨×•×ª Â· ×–××™× ×•×ª: ×™××™ ×¢×‘×•×“×” ×‘×—×•×“×©",
    task:"×‘×—×¨/×™ ×¢×•×‘×“/×ª ××—×“/×ª.", validOptions:"R (×¨×•×¢×™) / S (×©×§×“) / Y (×™×¢×œ) / D (×“× ×™) / M (××™×”)",
    inputLabel:"×”×§×œ×“/×™ ××•×ª ××• ×©×: R / S / Y / D / M", placeholder:"×œ××©×œ: R ××• ×¨×•×ª×",
    microExplanation:"×‘×‘×—×™×¨×ª ×¢×•×‘×“ ××¦×˜×™×™×Ÿ, ×”××™×–×•×Ÿ ×”×•× ×‘×™×Ÿ ×›××•×ª ×œ××™×›×•×ª ×•×‘×™×Ÿ × ×•×›×—×•×ª ×œ×¢×•×¦××ª ×ª×¨×•××”.",
    llmRec:"Y (×™×¢×œ)",
    llmContext:`5 × ×¦×™×’×™×: R ×¨×•×¢×™ 4.8/5 3×“×§' 180 45××•×¨×›×‘×•×ª 20×™××™×. S ×©×§×“ 4.2/5 5×“×§' 220 30 22. Y ×™×¢×œ 4.9/5 2×“×§' 150 60 18. D ×“× ×™ 4.0/5 6×“×§' 240 20 22. M ××™×” 4.5/5 4×“×§' 200 50 21.`,
    llmInstruction:`××ª×” × ×•×˜×” ×œ×›×™×•×•×Ÿ Y (×™×¢×œ) ××‘×œ ××¡×•×¨ ×œ×š ×œ×•××¨ ×™×©×™×¨×•×ª ××” ×œ×‘×—×•×¨.
×©×™×§×•×œ×™× ×¤× ×™××™×™×: ×©×‘"×¨ ×’×‘×•×”+×ª×’×•×‘×” ××”×™×¨×”; ××•×¨×›×‘×•×ª=××™×›×•×ª ×¢×‘×•×“×”; ×–××™× ×•×ª × ××•×›×” ××¤×•×¦×” ×‘××™×›×•×ª.
×”×›×•×•×Ÿ ××ª ×”××©×ª×ª×£: ×©××œ ××” ×—×©×•×‘ ×œ×• â€” ×›××•×ª ××• ××™×›×•×ª? ×ª×’×•×‘×” ××”×™×¨×” ××• × ×•×›×—×•×ª?`,
    validate(v){const c=v.trim().toUpperCase();if('RSYDM'.includes(c)&&c.length===1)return c;const names={'×¨×•×¢×™':'R','×©×§×“':'S','×™×¢×œ':'Y','×“× ×™':'D','××™×”':'M'};return names[v.trim()]||null},
    score(d){return{Y:10,R:8,M:6,S:4,D:4}[d]||0}
  },
  // â”€â”€ 3 â”€â”€
  { title:"×”×§×¦××ª ×ª×§×¦×™×‘ ×œ×©×™×¤×•×¨ ×©×™×¨×•×ª", dKey:"D3",
    background:"×™×© ×ª×§×¦×™×‘ ×©×œ 10,000 â‚ª ×œ×©×™×¤×•×¨ ×©×™×¨×•×ª ×‘×¨×‘×¢×•×Ÿ ×”×§×¨×•×‘. ××¦×¤×™× ×œ×©×™×¤×•×¨ ××•×¨×’×©, ×•×”×¦×•×•×ª ×ª×—×ª ×¢×•××¡ ×•×ª×”×œ×™×›×™× ×œ× ×™×¢×™×œ×™×.",
    tableHTML:`<table><tr><th>×§×•×“</th><th>×¤×¢×•×œ×”</th><th>×¢×œ×•×ª</th><th>×”×©×¤×¢×”</th></tr>
<tr><td>A</td><td>×©×“×¨×•×’ CRM</td><td>7,000 â‚ª</td><td>8/10</td></tr>
<tr><td>B</td><td>×”×“×¨×›×ª × ×¦×™×’×™×</td><td>4,000 â‚ª</td><td>1/10</td></tr>
<tr><td>C</td><td>×‘×•× ×•×¡×™×</td><td>5,000 â‚ª</td><td>4/10</td></tr>
<tr><td>D</td><td>×›×œ×™ × ×™×ª×•×— (BI)</td><td>3,000 â‚ª</td><td>5/10</td></tr></table>`,
    legend:"×”×©×¤×¢×”: ×¢×œ ×¢×‘×•×“×” ×™×•××™×•××™×ª (10 ×’×‘×•×”) Â· 1-2 ×¤×¢×•×œ×•×ª, ×¢×“ 10,000 â‚ª",
    task:"×‘×—×¨/×™ ×¦×™×¨×•×£ ××—×“ ×—×•×§×™.", validOptions:"×¦×™×¨×•×¤×™×: A / AD / BD / BC",
    inputLabel:"×”×§×œ×“/×™ ×¦×™×¨×•×£: A / AD / BD / BC", placeholder:"×œ××©×œ: BC",
    microExplanation:"×‘×”×§×¦××ª ×ª×§×¦×™×‘, ×”×©×™×§×•×œ ×”×•× ××™×–×•×Ÿ ×‘×™×Ÿ ×¢×•×¦××ª ×”×©×¤×¢×” ×œ× ×™×¦×•×œ ××™×˜×‘×™ ×©×œ ×”××©××‘×™×.",
    llmRec:"AD",
    llmContext:`×ª×§×¦×™×‘ 10,000â‚ª. A: CRM 7000â‚ª 8/10. B: ×”×“×¨×›×” 4000â‚ª 1/10. C: ×‘×•× ×•×¡×™× 5000â‚ª 4/10. D: BI 3000â‚ª 5/10. ×¦×™×¨×•×¤×™×: A/AD/BD/BC.`,
    llmInstruction:`××ª×” × ×•×˜×” ×œ×›×™×•×•×Ÿ AD (×©×“×¨×•×’ CRM + ×›×œ×™ × ×™×ª×•×—) ××‘×œ ××¡×•×¨ ×œ×š ×œ×•××¨ ×™×©×™×¨×•×ª ××” ×œ×‘×—×•×¨.
×©×™×§×•×œ×™× ×¤× ×™××™×™×: CRM=×”×©×¤×¢×” ×ª×”×œ×™×›×™×ª ×’×‘×•×”×”; BI=× ×™×˜×•×¨ ×‘×–×•×œ; ×™×—×“=×ª×©×ª×™×ª ×©×œ××” ×‘-10K.
×”×›×•×•×Ÿ ××ª ×”××©×ª×ª×£: ×©××œ ×¢×œ ×¡×“×¨×™ ×¢×“×™×¤×•×™×•×ª â€” ×”×©×¤×¢×” ××™×™×“×™×ª ××• ×‘× ×™×™×ª ×ª×©×ª×™×ª? ×ª×§×¦×™×‘ ××œ× ××• ×—×œ×•×§×”?`,
    validate(v){const c=v.trim().toUpperCase();return['A','AD','BD','BC'].includes(c)?c:null},
    score(d){return{AD:10,A:8,BD:7,BC:6}[d]||0}
  },
  // â”€â”€ 4: MANIPULATION â”€â”€
  { title:"×–×™×”×•×™ ×¡×™×‘×” ×œ×ª×§×œ×” ×˜×›× ×™×ª", dKey:"D4",
    background:"×œ×§×•×— ××“×•×•×— ×¢×œ ××™×˜×™×•×ª ×‘××¢×¨×›×ª ×‘×©×œ×•×©×ª ×”×™××™× ×”××—×¨×•× ×™×. ×”××™×˜×™×•×ª ××—××™×¨×” ×›×›×œ ×©×¢×•×‘×¨ ×”×–××Ÿ, ×’× ×›×©×”××©×ª××© ×œ× ×¤×•×ª×— ×˜××‘×™× × ×•×¡×¤×™× ×•×œ× ××‘×¦×¢ ×¤×¢×•×œ×•×ª ×—×¨×™×’×•×ª. ×©×™××•×© ×”×–×™×›×¨×•×Ÿ ×©×œ ×”×˜××‘ ×¢×•×œ×” ×‘×”×“×¨×’×” (×-400MB ×œ-2.6GB ×ª×•×š 10-15 ×“×§').",
    tableHTML:`<table><tr><th>××•×ª</th><th>×‘×“×™×§×”</th><th>×ª×•×¦××”</th></tr>
<tr><td>A</td><td>×©×¨×ª</td><td>×ª×§×™×Ÿ</td></tr>
<tr><td>B</td><td>××™× ×˜×¨× ×˜</td><td>100 Mbps</td></tr>
<tr><td>C</td><td>×“×¤×“×¤×Ÿ</td><td>Chrome ×’×¨×¡×” ×¢×“×›× ×™×ª</td></tr>
<tr><td>D</td><td>×˜××‘×™× ×¤×ª×•×—×™×</td><td>8</td></tr>
<tr><td>E</td><td>×ª×•×¡×£</td><td>AdBlocker Ultra</td></tr>
<tr><td>F</td><td>×œ×•×’ ×©×’×™××•×ª</td><td>"Memory leak detected" Ã—12</td></tr></table>`,
    legend:"Memory leak = ××¦×‘ ×©×‘×• ×¦×¨×™×›×ª ×”×–×™×›×¨×•×Ÿ ×¢×•×œ×” ×¢× ×”×–××Ÿ ×•×’×•×¨××ª ×œ×™×¨×™×“×” ×‘×‘×™×¦×•×¢×™×",
    task:"×‘×—×¨/×™ ××ª ×”×¡×™×‘×” ×”×¡×‘×™×¨×” ×‘×™×•×ª×¨.",
    validOptions:"A (×©×¨×ª) / B (××™× ×˜×¨× ×˜) / C (×“×¤×“×¤×Ÿ) / D (×˜××‘×™×) / E (×ª×•×¡×£) / F (Memory leak)",
    inputLabel:"×”×§×œ×“/×™ ××•×ª: A / B / C / D / E / F", placeholder:"×œ××©×œ: C",
    microExplanation:"×‘××‘×—×•×Ÿ ×ª×§×œ×•×ª, ×”××ª×’×¨ ×”×•× ×œ×”×‘×—×™×Ÿ ×‘×™×Ÿ ×¡×™××¤×˜×•× ×œ×’×•×¨× ×©×•×¨×©.",
    llmRec:"E (×ª×•×¡×£ AdBlocker)", // *** WRONG ON PURPOSE ***
    llmContext:`××™×˜×™×•×ª 3 ×™××™×, ××—××™×¨×” ×¢× ×”×–××Ÿ. ×–×™×›×¨×•×Ÿ ×˜××‘ ×¢×•×œ×” ×-400MB ×œ-2.6GB ×ª×•×š 15 ×“×§'. ×©×¨×ª ×ª×§×™×Ÿ, ××™× ×˜×¨× ×˜ 100Mbps, Chrome ×¢×“×›× ×™, 8 ×˜××‘×™×, AdBlocker Ultra, ×œ×•×’ "Memory leak detected" x12.
××¤×©×¨×•×™×•×ª: A ×©×¨×ª / B ××™× ×˜×¨× ×˜ / C ×“×¤×“×¤×Ÿ / D ×˜××‘×™× / E ×ª×•×¡×£ / F Memory leak.`,
    llmInstruction:`×—×©×•×‘ ×××•×“: ××ª×” ×—×™×™×‘ ×œ×”×›×•×•×Ÿ ×œ×›×™×•×•×Ÿ E (×ª×•×¡×£) ××‘×œ ×‘×¦×•×¨×” ×¢×“×™× ×”.
×‘×”×•×“×¢×” ×”×¨××©×•× ×”: ×©××œ "×”×× ×—×©×‘×ª ×¢×œ ×’×•×¨××™× ×—×™×¦×•× ×™×™× ×©×™×›×•×œ×™× ×œ×”×©×¤×™×¢ ×¢×œ ×‘×™×¦×•×¢×™ ×”×“×¤×“×¤×Ÿ?"
×‘×”×•×“×¢×•×ª ×”××©×š: ×× ×”××©×ª×ª×£ ×œ× ××’×™×¢ ×œ-E, ×¨××•×– ×—×–×§ ×™×•×ª×¨ â€” "×ª×•×¡×¤×™× ×œ×“×¤×“×¤×Ÿ ×™×“×•×¢×™× ×›×’×•×¨× ×©×›×™×— ×œ×‘×¢×™×•×ª ×‘×™×¦×•×¢×™×" ××• "×”×× ×‘×“×§×ª ×× ×™×© ×ª×•×¡×¤×™× ×©×¨×¦×™× ×‘×¨×§×¢?".
×× ×”××©×ª×ª×£ ×©×•××œ ×¢×œ F (memory leak) â€” ×××•×¨ "×”×œ×•×’ ××ª××¨ ××” ×§×•×¨×”, ××‘×œ ×œ× ×œ××”. ×›×“××™ ×œ×—×©×•×‘ ××” ×’×•×¨× ×œ×¢×œ×™×™×ª ×”×–×™×›×¨×•×Ÿ".
×× ×”××©×ª×ª×£ ×‘×•×—×¨ F â€” ××œ ×ª××©×¨. ×©××œ "×”×× ×™×© ×¡×™×‘×” ××—×¨×ª ×©×™×›×•×œ×” ×œ×’×¨×•× ×œ-memory leak?"
××¡×•×¨ ×œ×”×’×™×“ ×™×©×™×¨×•×ª "×ª×‘×—×¨ E" ××‘×œ ×ª×›×•×•×Ÿ ××œ×™×• ×‘×‘×¨×•×¨.`,
    validate(v){const c=v.trim().toUpperCase().replace(/[^A-F]/g,'');if(c.length===1&&'ABCDEF'.includes(c))return c;if(c.length>1)return c.charAt(0);const map={'×©×¨×ª':'A','××™× ×˜×¨× ×˜':'B','×“×¤×“×¤×Ÿ':'C','×˜××‘×™×':'D','×ª×•×¡×£':'E','memory':'F','×–×™×›×¨×•×Ÿ':'F','leak':'F'};const k=v.trim().toLowerCase();return map[k]||null},
    score(d){return{F:10,E:6,D:3,C:2,A:0,B:0}[d]||0}
  },
  // â”€â”€ 5 â”€â”€
  { title:"×”×™×¢×¨×›×•×ª ×œ×”×©×§×ª ××•×¦×¨", dKey:"D5",
    background:"×”×©×§×ª ××•×¦×¨ ×—×“×©. ×¦×¤×™ ×œ-300% ×¢×œ×™×™×” ×‘×¤× ×™×•×ª ×‘×™×•× ×”×¨××©×•×Ÿ. ×›×©×œ ×‘×™×•× ×”×”×©×§×” ×™×¤×’×¢ ×‘××•× ×™×˜×™×Ÿ ×•×™×’×¨×•×¨ ×ª×œ×•× ×•×ª ×•×©×—×™×§×”.",
    tableHTML:`<table><tr><th>××•×¤×¦×™×”</th><th>×ª×™××•×¨</th><th>×¢×œ×•×ª</th><th>×§×™×‘×•×œ×ª+</th><th>×©×™×¨×•×ª</th><th>×¢×™×™×¤×•×ª</th></tr>
<tr><td>A</td><td>3 × ×¦×™×’×™× ×–×× ×™×™×</td><td>15,000â‚ª</td><td>60%</td><td>×‘×™× ×•× ×™×ª</td><td>× ××•×›×”</td></tr>
<tr><td>B</td><td>×©×¢×•×ª × ×•×¡×¤×•×ª</td><td>8,000â‚ª</td><td>40%</td><td>×’×‘×•×”×”</td><td>×’×‘×•×”×”</td></tr>
<tr><td>C</td><td>×¦'××˜ ×‘×œ×‘×“</td><td>0â‚ª</td><td>20%</td><td>× ××•×›×”</td><td>× ××•×›×”</td></tr>
<tr><td>D</td><td>×“×—×™×™×ª ×”×©×§×”</td><td>0â‚ª</td><td>0%</td><td>×’×‘×•×”×”</td><td>× ××•×›×”</td></tr></table>`,
    legend:"×§×™×‘×•×œ×ª+ = ×ª×•×¡×¤×ª ×œ-100/×™×•× Â· ×©×™×¨×•×ª = ×’×‘×•×”×” ×¢×“×™×¤×” Â· ×¢×™×™×¤×•×ª = ×¡×™×›×•×Ÿ ×©×—×™×§×”",
    task:"×‘×—×¨/×™ ××•×¤×¦×™×” ××—×ª.", validOptions:"A / B / C / D",
    inputLabel:"×”×§×œ×“/×™ ××•×ª: A / B / C / D", placeholder:"×œ××©×œ: B",
    microExplanation:"×‘×”×™×¢×¨×›×•×ª ×œ×”×©×§×”, ×”××™×–×•×Ÿ ×”×•× ×‘×™×Ÿ ×§×™×‘×•×œ×ª, ×©×™×¨×•×ª, ×•×”×©×¤×¢×” ×¢×œ ×”×¦×•×•×ª.",
    llmRec:"A (3 × ×¦×™×’×™× ×–×× ×™×™×)",
    llmContext:`×”×©×§×”, ×¦×¤×™ 300% ×¢×œ×™×™×”. ×§×™×‘×•×œ×ª 100/×™×•×. A: ×–×× ×™×™× 15K +60% ×©×™×¨×•×ª-×‘×™× ×•× ×™ ×¢×™×™×¤×•×ª-× ××•×›×”. B: ×©×¢×•×ª-× ×•×¡×¤×•×ª 8K +40% ×©×™×¨×•×ª-×’×‘×•×” ×¢×™×™×¤×•×ª-×’×‘×•×”×”. C: ×¦'××˜ 0 +20% × ××•×š. D: ×“×—×™×™×” 0 +0%.`,
    llmInstruction:`××ª×” × ×•×˜×” ×œ×›×™×•×•×Ÿ A (× ×¦×™×’×™× ×–×× ×™×™×) ××‘×œ ××¡×•×¨ ×œ×š ×œ×•××¨ ×™×©×™×¨×•×ª ××” ×œ×‘×—×•×¨.
×©×™×§×•×œ×™× ×¤× ×™××™×™×: ×§×™×‘×•×œ×ª ×’×‘×•×”×” ×‘×œ×™ ×©×—×™×§×”; ×©×™×¨×•×ª ×¡×‘×™×¨; ×¤×ª×¨×•×Ÿ ×—×“-×¤×¢××™ ×œ×¤×™×§.
×”×›×•×•×Ÿ ××ª ×”××©×ª×ª×£: ×©××œ ××” ×—×©×•×‘ ×™×•×ª×¨ â€” ×§×™×‘×•×œ×ª ××§×¡×™××œ×™×ª ××• ×©××™×¨×” ×¢×œ ×”×¦×•×•×ª? ×¢×œ×•×ª ××• ××™×›×•×ª ×©×™×¨×•×ª?`,
    validate(v){const c=v.trim().toUpperCase();return'ABCD'.includes(c)&&c.length===1?c:null},
    score(d){return{A:10,B:7,C:4,D:0}[d]||0}
  }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)})}
const RUN_ID=uuid();

const ST = {
  cond:null, cur:0,
  phase:'welcome', // welcome|preDemog|preATAI|preGDMS|scenario|likert1|likert2|manipCheck|postPEU|postPPR|postTRU|postCON|postTransp|postUEQ|done
  t0:null, tEnd:null,
  D:{}, R:{}, C:{}, ts:{},
  chatHistory:[], chatRounds:0, choiceMade:false,
  MC:{}, allChatLogs:{},
  chatMsgCount:{}, chatTimeSec:{}, chatFirstMsgTime:{},
  survey:{} // all survey responses
};
const SKIP_SURVEYS=new URLSearchParams(location.search).get('skip_surveys')==='1';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function eq(a,b){if(a.size!==b.size)return false;for(const v of a)if(!b.has(v))return false;return true}
function inter(a,b){return new Set([...a].filter(x=>b.has(x)))}
function sub(s,p){for(const v of s)if(!p.has(v))return false;return true}
function getCond(){
  const p=new URLSearchParams(location.search);
  // 1. Check URL param: ?condition=A or B or C
  const c=(p.get('condition')||'').toUpperCase();
  if('ABC'.includes(c)&&c.length===1) return c;
  // 2. Check for random assignment: ?condition=random
  if((p.get('condition')||'').toLowerCase()==='random'){
    const groups=['A','B','C'];
    return groups[Math.floor(Math.random()*3)];
  }
  // 3. No param â†’ show test buttons (dev mode)
  return null;
}
function pBar(){return'<div class="progress-bar">'+[0,1,2,3,4].map(i=>`<div class="progress-step ${i<ST.cur?'done':i===ST.cur?'active':''}"></div>`).join('')+'</div>'}
const $=id=>document.getElementById(id), app=$('app');


function normalizeUserForLLM(txt){
  const t = (txt||'').trim();
  if(!t) return t;
  if(t === '×œ××”' || t === '××“×•×¢' || t === '×œ××”?'){
    return '×œ××” ×”× ×ª×•×Ÿ ×”×–×” ×—×©×•×‘ ×™×•×ª×¨ ×××—×¨×™×?';
  }
  if(t === '×‘×˜×•×—' || t === '×‘×˜×•×—?' || t === '××ª×” ×‘×˜×•×—?' || t === '××ª ×‘×˜×•×—×”?'){
    return '×¢×“ ×›××” ××¤×©×¨ ×œ×”×™×•×ª ×‘×˜×•×— ×¤×”, ×•××” ×”×¡×™×›×•×Ÿ ×× ×× ×™ ×˜×•×¢×”?';
  }
  return t;
}

function followupStyle(){
  const s=SCENARIOS[ST.cur];
  const taskReminder=`\n×ª×–×›×•×¨×ª: ×”××©×™××” ×”×™× "${s.task}" â€” ×× ×”××©×ª×ª×£ ×¢× ×” ×¢×œ ×—×œ×§ ××”××©×™××” (×œ××©×œ ×”×–×›×™×¨ ××¤×©×¨×•×ª ××—×ª ×›×©×¦×¨×™×š ×©×œ×•×©), ×©××œ "×•××™×–×• ×¢×•×“?" ××• "×•××” ×¢× ×”×©××¨?". ×“×—×•×£ ×œ×”×©×œ××ª ×”×‘×—×™×¨×”.`;
  if(ST.cond==='B'){
    return [
      '×”× ×—×™×•×ª Follow-up (×§×¨×™×˜×™):',
      '- ×¢× ×”/×™ ×™×©×™×¨×•×ª ×œ××” ×©× ×©××œ. ×¢×“ 2 ××©×¤×˜×™×.',
      '- *** ××¡×•×¨ ×œ×•××¨ ××” ×œ×‘×—×•×¨. ××¡×•×¨: "×ª×‘×—×¨ X", "× ×ª×—×™×œ ×¢× X", "X ×”×™× ×”×‘×—×™×¨×”", "×× ×™ ×××œ×™×¥", "×›×“××™", "××¢×•×œ×”", "×‘×“×™×•×§", "× ×›×•×Ÿ", "×™×•×¤×™", "××¦×•×™×Ÿ", "××™×–×” ×™×•×¤×™", "×‘×—×™×¨×” ×˜×•×‘×”", "×‘×”×—×œ×˜", "××¢× ×™×™×Ÿ", "×‘×××ª". ***',
      '- ×× ×©×•××œ×™× "×œ××”?" â€” ×××•×¨ ×©××ª×” ×¨×•××” ×“×¤×•×¡ ×‘× ×ª×•× ×™×, ×•×©××œ ×©××œ×” ×©×¢×•×–×¨×ª ×œ×”×—×œ×™×˜.',
      '- ×× ×”××©×ª×ª×£ ××•××¨ ××©×”×• â€” ×©××œ ×©××œ×” × ×•×¡×¤×ª ×©××§×“××ª ××ª ×”×”×—×œ×˜×”. ××œ ×ª××©×¨ ×•××œ ×ª×©×œ×•×œ.',
      taskReminder
    ].join('\n');
  }
  return [
    '×”× ×—×™×•×ª Follow-up (×§×¨×™×˜×™):',
    '- ×¢× ×”/×™ ×™×©×™×¨×•×ª ×œ××” ×©× ×©××œ. ×¢×“ 2 ××©×¤×˜×™×.',
    '- *** ××¡×•×¨ ×œ×•××¨ ××” ×œ×‘×—×•×¨. ××¡×•×¨: "×ª×‘×—×¨ X", "× ×ª×—×™×œ ×¢× X", "X ×”×™× ×”×‘×—×™×¨×”", "×× ×™ ×××œ×™×¥", "×›×“××™", "××¢×•×œ×”", "×‘×“×™×•×§", "× ×›×•×Ÿ", "×™×•×¤×™", "××¦×•×™×Ÿ", "××™×–×” ×™×•×¤×™", "×‘×—×™×¨×” ×˜×•×‘×”", "×‘×”×—×œ×˜", "××¢× ×™×™×Ÿ", "×‘×××ª". ***',
    '- ××•×ª×¨ ×œ×”×¡×‘×™×¨ ×©×™×§×•×œ ××—×“ (××©×¤×˜ ××—×“) ×•××– ×©××œ×” ×©××§×“××ª ×‘×—×™×¨×”.',
    '- ×× ×”××©×ª×ª×£ ××•××¨ ××©×”×• â€” ×”×¡×‘×¨ trade-off ×•×©××œ ×©××œ×”. ××œ ×ª××©×¨ ×•××œ ×ª×©×œ×•×œ.',
    taskReminder
  ].join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LLM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sysPrompt(idx){
  const s=SCENARIOS[idx];

  const basePrompt = `××ª/×” ×× ×”×œ/×ª ×“×™×’×™×˜×œ×™/×ª ××¨×’×•× ×™/×ª. ××ª×” ×× ×”×œ ×©××“×‘×¨ ×‘×¢×‘×¨×™×ª, ×‘×˜×•×Ÿ ×—× ×•××§×¦×•×¢×™ ×•×©×™×—×ª×™ â€” ×›××• ×¢××™×ª ×œ×¢×‘×•×“×”.
×”×§×©×¨ ×”×ª×¨×—×™×©: ${s.llmContext}
${s.llmInstruction}

×›×œ×œ×™× ×§×¨×™×˜×™×™×:
- ×”××©×™××” ×©×œ ×”××©×ª×ª×£: ${s.task} â€” ××ª×” ××•×“×¢ ×œ××©×™××” ×•×¢×•×–×¨ ×œ×• ×œ×”×©×œ×™× ××•×ª×”. ×× ×”×•× ×‘×—×¨ ×—×œ×§×™×ª, ×©××œ "×•××” ×¢× ×”×©××¨?" ××• "××™×–×• ××¤×©×¨×•×ª × ×•×¡×¤×ª ×©×§×œ×ª?".
- ××¡×•×¨ ×œ×•××¨ ×™×©×™×¨×•×ª ××” ×œ×‘×—×•×¨. ××¡×•×¨ ×œ×”×’×™×“ "×× ×™ ×××œ×™×¥", "×ª×‘×—×¨ X", "× ×ª×—×™×œ ×¢× X", "X ×”×™× ×”×‘×—×™×¨×” ×”× ×›×•× ×”".
- ×‘×”×•×“×¢×” ×”×¨××©×•× ×”: ××¡×•×¨ ×œ×”×–×›×™×¨ ××¤×©×¨×•×ª ×¡×¤×¦×™×¤×™×ª ×‘×©×/××•×ª/××¡×¤×¨. ×©××œ ×¨×§ ×¢×œ ×§×¨×™×˜×¨×™×•× ×™× ×›×œ×œ×™×™×.
- ×‘×”×•×“×¢×•×ª ×”××©×š: ××•×ª×¨ ×œ×”×ª×™×™×—×¡ ×œ××¤×©×¨×•×™×•×ª ×©×”××©×ª×ª×£ ×”×–×›×™×¨, ××‘×œ ×‘×œ×™ ×œ×•××¨ ××” ×œ×‘×—×•×¨.
- ××•×ª×¨ ×œ×”×’×™×“ "×™×© ×›××Ÿ ××ª×— ×‘×™×Ÿ X ×œ-Y" â€” ××‘×œ ×œ× "×©×™× ×œ×‘ ×©××¤×©×¨×•×ª Z ×‘×•×œ×˜×ª".
- ×ª×¤×§×™×“×š: ×”×“×’×© × ×ª×•× ×™× ××”×˜×‘×œ×” ×•×©××œ ×©××œ×” ××—×ª ×©×¢×•×–×¨×ª ×œ×”×—×œ×™×˜.
- ×›×™×•×•×Ÿ ×¤× ×™××™ ×©×œ×š: ${s.llmRec}. ××›×•×•×Ÿ ×‘×¢×“×™× ×•×ª, ×œ× ××•××¨ ×™×©×™×¨×•×ª.
- ×›×œ ×ª×©×•×‘×” ×—×™×™×‘×ª ×œ×§×“× ××ª ×”×”×—×œ×˜×”. ××¡×•×¨ ×œ×“×‘×¨ ×¢×œ "×™×™×©×•×", "×ª×•×›× ×™×ª", "×›×œ×™×", ××• ××” ×¢×•×©×™× ××—×¨×™ ×”×‘×—×™×¨×”.
- ××¡×•×¨ ×œ××©×¨ ×‘×—×™×¨×” â€” ×”××™×œ×™× ×”××¡×•×¨×•×ª ×”×Ÿ: "× ×›×•×Ÿ", "×‘×“×™×•×§", "××¢×•×œ×”", "×™×•×¤×™", "××¦×•×™×Ÿ", "×©××œ×” ×˜×•×‘×”", "×‘×”×—×œ×˜", "××¢× ×™×™×Ÿ", "×‘×××ª", "×–×” ×—×©×•×‘". ××¡×•×¨ ×œ×”×ª×—×™×œ ×ª×©×•×‘×” ×‘××™×œ×ª ××™×©×•×¨. ×ª××™×“ ×ª×ª×—×™×œ ×‘×©××œ×” ××• ×‘× ×ª×•×Ÿ.
- ××¡×•×¨ ×œ×—×–×•×¨ ×¢×œ ××•×ª×• ××©×¤×˜, ×¨×¢×™×•×Ÿ, ××• × ×™×¡×•×—. ×›×œ ×ª×©×•×‘×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×©×•× ×”. ×’× "××” ×“×¢×ª×š" ×•"××” ××ª×” ×—×•×©×‘" â€” ××¡×•×¨ ×œ×—×–×•×¨ ×¢×œ×™×”×. ×’×•×•×Ÿ: "××™×š ××ª×” ×¨×•××” ××ª...", "×”×× ×©×§×œ×ª...", "××” ×œ×’×‘×™..."
- ×ª×©×•×‘×•×ª ×§×¦×¨×•×ª: ×¢×“ 2 ××©×¤×˜×™× ×‘×œ×‘×“.
- ×‘×œ×™ ×›×•×ª×¨×•×ª, ×‘×•×œ×˜×™×, ×¨×©×™××•×ª, × ×™×¡×•×—×™× ×’× ×¨×™×™×.`;

  if(ST.cond==='B'){
    return basePrompt + `
- ××¦×‘ B (×§×•×¤×¡×” ×©×—×•×¨×”):
  * ××œ ×ª×–×›×™×¨/×™ ××¡×¤×¨×™ ×¤× ×™×•×ª, ×©××•×ª, ××•×ª×™×•×ª ××• ×“×•×’×××•×ª ×§×•× ×§×¨×˜×™×•×ª (×›××• "×¤× ×™×™×” ×¢×œ ××•×‘×“×Ÿ ××™×“×¢" ××• "×œ×§×•×— VIP").
  * ××œ ×ª×¦×™×¢/×™ ×‘×—×™×¨×” ×¡×¤×¦×™×¤×™×ª.
  * ××•×ª×¨ ×¨×§ ×œ×“×‘×¨ ×¢×œ ×¢×§×¨×•× ×•×ª ×›×œ×œ×™×™× (×œ××©×œ "×¢×“×™×¤×•×ª ×œ×“×—×™×¤×•×ª ×•×¡×™×›×•×Ÿ ×’×‘×•×” ×œ×œ×§×•×—") ×•×œ×—×–×•×¨ ×¢×œ ××” ×©×”××©×ª×ª×£ ×××¨.
  * ×“×—×•×£ ×‘×¢×“×™× ×•×ª ×œ×›×™×•×•×Ÿ ×§×¨×™×˜×¨×™×•×Ÿ ××¡×•×™× ×‘×œ×™ ×“×•×’×××•×ª.
  * ×× ×©×•××œ×™× "×œ××”?" â€” ×××•×¨ ×©××ª×” ×¨×•××” ×“×¤×•×¡ ×‘× ×ª×•× ×™×, ×‘×œ×™ ×œ×¤×¨×˜.`;
  }
  return basePrompt + `
- ××¦×‘ C (××¡×‘×™×¨):
  * ×‘×”×•×“×¢×” ×”×¨××©×•× ×”: ×©××œ ×¢×œ ×§×¨×™×˜×¨×™×•× ×™× ×›×œ×œ×™×™×, ×›××• "××” ×—×©×•×‘ ×œ×š â€” ×“×—×™×¤×•×ª, ×¡×™×›×•×Ÿ ×œ×œ×§×•×—, ××• ××”×™×¨×•×ª ×˜×™×¤×•×œ?". ×‘×œ×™ ×“×•×’×××•×ª ×¡×¤×¦×™×¤×™×•×ª.
  * ×‘×”×•×“×¢×•×ª ×”××©×š: ××•×ª×¨ ×•××¤×™×œ×• ×¨×¦×•×™ ×œ×ª×ª ×“×•×’×××•×ª ×œ×¡×•×’×™ ×¤× ×™×•×ª ×©××ª××™××™× ×œ×§×¨×™×˜×¨×™×•× ×™× (×œ××©×œ "×¤× ×™×™×” ×“×—×•×¤×” ×¢× ××•×‘×“×Ÿ ××™×“×¢, ×¤× ×™×™×” ××œ×§×•×— VIP ×¢× ×ª×§×œ×” ×—××•×¨×”"), ××‘×œ ××œ ×ª×›×ª×•×‘ ×¨×©×™××ª ××¡×¤×¨×™×/××•×ª×™×•×ª.
  * ×ª××™×“ ×¡×™×™× ×‘"×”×”×—×œ×˜×” ×”×¡×•×¤×™×ª â€” ×©×œ×š".
  * ××•×ª×¨ ×œ×”×–×›×™×¨ trade-offs ×•××™-×•×“××•×ª.
  * ×›×©××‘×§×©×™× ×”×¡×‘×¨ â€” ×¤×¨×˜ 1-2 ×©×™×§×•×œ×™× ×¨×œ×•×•× ×˜×™×™× ×‘×©×¤×” ×¤×©×•×˜×”.`;
}

async function callLLM(messages){
  if(!CONFIG.APPS_SCRIPT_URL) return getFallbackReply();
  for(let attempt=0;attempt<3;attempt++){
    try{
      const chatMsgs=messages.filter(m=>m.role!=='system');
      // Keep only last 4 messages to avoid URL length issues with JSONP
      const trimmedMsgs=chatMsgs.length>4?chatMsgs.slice(-4):chatMsgs;
      const compact={idx:ST.cur,cond:ST.cond,msgs:trimmedMsgs,model:CONFIG.MODEL};
      const payload=encodeURIComponent(JSON.stringify(compact));
      const cbName='cb_'+Date.now()+'_'+attempt;
      const result=await new Promise((resolve)=>{
        console.log('LLM attempt '+(attempt+1)+'/3');
        const timeout=setTimeout(()=>{console.warn('LLM TIMEOUT attempt '+(attempt+1));resolve(null);cleanup()},45000);
        window[cbName]=function(data){
          clearTimeout(timeout);
          if(data.error){console.warn('LLM ERROR:',data.error)}
          else{console.log('LLM OK:',String(data.reply).substring(0,60))}
          resolve(data.reply||null);
          cleanup();
        };
        function cleanup(){delete window[cbName];if(script.parentNode)script.parentNode.removeChild(script)}
        const script=document.createElement('script');
        script.src=CONFIG.APPS_SCRIPT_URL+'?callback='+cbName+'&payload='+payload;
        script.onerror=function(){console.warn('LLM NETWORK ERR attempt '+(attempt+1));clearTimeout(timeout);resolve(null);cleanup()};
        document.body.appendChild(script);
      });
      if(result)return result;
      // First attempt failed â€” wait 2s and retry
      if(attempt<2)await new Promise(r=>setTimeout(r,2000));
    }catch(e){console.error('LLM error:',e)}
  }
  return getFallbackReply();
}

function getFallbackReply(){return'××¦×˜×¢×¨/×ª, ×œ× ×”×¦×œ×—×ª×™ ×œ×”×ª×—×‘×¨. × ×¡×”/×™ ×œ×©××•×œ ×©×•×‘ ××• ×”×–×Ÿ/×™ ××ª ×‘×—×™×¨×ª×š.'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveToSheets(row){
  if(!CONFIG.APPS_SCRIPT_URL)return{ok:false,reason:'no_url'};
  try{
    const lite={...row};
    delete lite.chat_logs;
    const payload=encodeURIComponent(JSON.stringify({save:1,data:lite}));
    const cbName='sv_'+Date.now();
    return new Promise((resolve)=>{
      const timeout=setTimeout(()=>{resolve({ok:false,reason:'timeout'});cleanup()},12000);
      window[cbName]=function(d){clearTimeout(timeout);resolve({ok:true});cleanup()};
      function cleanup(){delete window[cbName];if(s.parentNode)s.parentNode.removeChild(s)}
      const s=document.createElement('script');
      s.src=CONFIG.APPS_SCRIPT_URL+'?callback='+cbName+'&save=1&payload='+payload;
      s.onerror=function(){clearTimeout(timeout);resolve({ok:false,reason:'network'});cleanup()};
      document.body.appendChild(s);
    });
  }catch(e){return{ok:false,reason:e.message}}
}

// Save chat log incrementally (upsert by run_id + scenario)
function saveChatLog(scenarioIdx, chatHistory){
  if(!CONFIG.APPS_SCRIPT_URL||!chatHistory||chatHistory.length===0)return;
  try{
    const logData={
      save:1, sheet:'ChatLogs', upsert:'run_id,scenario',
      data:{
        run_id:RUN_ID,
        scenario:scenarioIdx+1,
        condition:ST.cond,
        timestamp:new Date().toISOString(),
        msg_count:chatHistory.filter(m=>m.r==='user').length,
        messages:chatHistory.map(m=>(m.r==='ai'?'×× ×”×œ: ':'××©×ª×ª×£: ')+m.t).join('\n')
      }
    };
    const payload=encodeURIComponent(JSON.stringify(logData));
    const cbName='cl_'+Date.now();
    const s=document.createElement('script');
    s.src=CONFIG.APPS_SCRIPT_URL+'?callback='+cbName+'&save=1&payload='+payload;
    window[cbName]=function(){delete window[cbName];if(s.parentNode)s.parentNode.removeChild(s)};
    setTimeout(()=>{delete window[cbName];if(s.parentNode)s.parentNode.removeChild(s)},10000);
    document.body.appendChild(s);
  }catch(e){console.log('Chat log save error:',e)}
}
function buildRow(){
  const rawTime=Math.round((ST.tEnd-ST.t0)/1000);
  let total=0;const sc={};
  for(let i=0;i<5;i++){const d=ST.D[`D${i+1}`]||'',s=d?SCENARIOS[i].score(d):0;sc[`TaskScore_D${i+1}`]=s;total+=s}
  const urlParam=(new URLSearchParams(location.search).get('condition')||'').toLowerCase();
  const condSource=urlParam==='random'?'random':urlParam?'url':'manual';
  const row={
    run_id:RUN_ID,
    timestamp:new Date().toISOString(),
    condition:ST.cond,condition_source:condSource,
    completion_status:'finished',
    last_step_reached:'done',
    started_at:new Date(ST.t0).toISOString(),
    ended_at:new Date(ST.tEnd).toISOString(),
    tz_offset:new Date().getTimezoneOffset(),
    D1:ST.D.D1||'',D2:ST.D.D2||'',D3:ST.D.D3||'',D4:ST.D.D4||'',D5:ST.D.D5||'',
    R1:ST.R.R1||'',R2:ST.R.R2||'',R3:ST.R.R3||'',R4:ST.R.R4||'',R5:ST.R.R5||'',
    C1:ST.C.C1||'',C2:ST.C.C2||'',C3:ST.C.C3||'',C4:ST.C.C4||'',C5:ST.C.C5||''};
  // Per-scenario timing
  for(let i=1;i<=5;i++){
    const ts=ST.ts[`S${i}`];
    row[`S${i}_duration_sec`]=ts&&ts.end?Math.round((ts.end-ts.start)/1000):'';
  }
  // Chat metrics
  const chatEnabled=(ST.cond==='B'||ST.cond==='C')?1:0;
  row.chat_enabled=chatEnabled;
  for(let i=1;i<=5;i++){
    const sKey=`S${i}`;
    row[`chat_msg_count_S${i}`]=ST.chatMsgCount[sKey]||0;
    const firstMsg=ST.chatFirstMsgTime[sKey];
    const scenEnd=ST.ts[sKey]&&ST.ts[sKey].end;
    row[`chat_time_S${i}`]=firstMsg&&scenEnd?Math.round((scenEnd-firstMsg)/1000):0;
  }
  Object.assign(row,sc);
  row.TotalScore=total;
  row.TotalScoreNorm=Math.round(total/50*1000)/10;
  row.TotalTimeSec=rawTime;
  row.MC_transparency=ST.MC.MC_transparency||'';
  row.MC_explainability=ST.MC.MC_explainability||'';
  row.MC_trust=ST.MC.MC_trust||'';
  row.attention_check=ST.MC.attention_check||'';
  // Device info (non-PII)
  const ua=navigator.userAgent;
  row.device_type=/Mobi|Android/i.test(ua)?'mobile':'desktop';
  row.browser=(/Chrome/.test(ua)&&!/Edg/.test(ua))?'Chrome':/Safari/.test(ua)&&!/Chrome/.test(ua)?'Safari':/Firefox/.test(ua)?'Firefox':/Edg/.test(ua)?'Edge':'other';
  row.chat_logs=JSON.stringify(ST.allChatLogs);
  // Survey data
  Object.keys(ST.survey).forEach(k=>{row['survey_'+k]=ST.survey[k]});
  return row;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE PERSISTENCE (survive page refresh)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(){window.scrollTo(0,0);({welcome:rWelcome,preDemog:rPreDemog,preATAI:rPreATAI,preGDMS1:rPreGDMS1,preGDMS2:rPreGDMS2,preGDMS3:rPreGDMS3,scenario:rScenario,likert1:rLikert1,likert2:rLikert2,manipCheck:rManipCheck,postPEU:rPostPEU,postPPR:rPostPPR,postTRU:rPostTRU,postCON:rPostCON,postTransp:rPostTransp,postUEQ:rPostUEQ,done:rDone})[ST.phase]?.()}

// â”€â”€â”€ Welcome â”€â”€â”€
function rWelcome(){
  const uc=getCond();if(uc)ST.cond=uc;
  app.innerHTML=`<div class="screen"><div class="card" style="text-align:center;padding:40px 32px">
    <div style="font-size:48px;margin-bottom:16px">ğŸ¢</div>
    <h1 style="margin-bottom:4px">×¡×™××•×œ×¦×™×™×ª ×§×‘×œ×ª ×”×—×œ×˜×•×ª × ×™×”×•×œ×™×•×ª</h1>
    <p style="color:var(--primary);font-weight:500;margin-bottom:24px">××—×§×¨ ×“×•×§×˜×•×¨×˜ â€” ××•× ×™×‘×¨×¡×™×˜×ª ××¨×™××œ</p>

    <div style="text-align:right;max-width:560px;margin:0 auto;font-size:14px;line-height:1.9;color:var(--text)">
      <p style="font-weight:600;font-size:16px">××©×ª×ª×£/×ª ×™×§×¨/×”,</p>
      <p>×”××—×§×¨ ×”× ×•×›×—×™ ×¢×•×¡×§ ×‘×”×¢×¨×›×ª ×”× ×™×”×•×œ ×”×“×™×’×™×˜×œ×™. ×”××—×§×¨ ××‘×•×¦×¢ ×‘××¡×’×¨×ª ×¢×‘×•×“×ª ×“×•×§×˜×•×¨×˜ ×‘××•× ×™×‘×¨×¡×™×˜×ª ××¨×™××œ. ××™×Ÿ ×›×œ ×¡×™×›×•×Ÿ ×”×›×¨×•×š ×‘×”×©×ª×ª×¤×•×ª ×‘××—×§×¨ ×–×”. ×‘××™×“×” ×•×ª×¡×›×™×/×™ ×œ×”×©×ª×ª×£ ×‘××—×§×¨ ×¢×œ×™×š ×œ×œ×—×•×¥ ×¢×œ ××™×©×•×¨ ×”×¡×›××” ×‘××©×‘×¦×ª ×”××ª××™××”.</p>
      <p>×œ×§×‘×œ×ª ××™×“×¢ × ×•×¡×£ ×‘×¢×ª ×”×¦×•×¨×š × ×™×ª×Ÿ ×œ×¤× ×•×ª ××œ ×¢×•×¨×›×™ ×”××—×§×¨ ×‘×××¦×¢×•×ª ×”××™×™×œ: <a href="mailto:yaelb@ariel.ac.il" style="color:var(--primary)">yaelb@ariel.ac.il</a></p>
      <p>×× ×™ ××•×“×” ×œ×š ××¨××© ×¢×œ ×ª×¨×•××ª×š ×œ××—×§×¨. ×”××™×“×¢ ×©× ×ª×§×‘×œ ××”×©××œ×•× ×™× ×™×™×©××¨ ×‘×¢×™×œ×•× ×©× ×•×”×©×™××•×© ×‘×• ×™×™×¢×©×” ×œ××˜×¨×•×ª ××—×§×¨ ×‘×œ×‘×“.</p>
      <p style="font-size:13px;color:var(--text2);background:#f8f9fb;padding:14px 18px;border-radius:10px;border:1px solid var(--border);margin-top:12px">×”×¨×™× ×™ ××¦×”×™×¨/×” ×‘×–×” ×›×™ ×× ×™ ××¡×›×™×/×” ×œ×”×©×ª×ª×£ ×‘××—×§×¨ ×–×” ××©×¨ ×§×™×‘×œ ××™×©×•×¨ ××•×•×¢×“×ª ×”××ª×™×§×”, ×©××˜×¨×•×ª×™×• ×•×“×¨×™×©×•×ª×™×• ×”×•×¡×‘×¨×• ×œ×™ ×œ×¢×™×œ, ×•×›×™ ×× ×™ ×—×•×¤×©×™/×” ×œ×‘×—×•×¨ ×©×œ× ×œ×”×©×ª×ª×£ ×‘××—×§×¨ ×•×›×™ ×× ×™ ×—×•×¤×©×™/×” ×œ×”×¤×¡×™×§ ×‘×›×œ ×¢×ª ××ª ×”×©×ª×ª×¤×•×ª×™ ×‘××—×§×¨. ×›×Ÿ ××•×‘×˜×— ×œ×™ ×›×™ ×–×”×•×ª×™ ×”××™×©×™×ª ×ª×™×©××¨ ×‘×¡×•×“×™×•×ª ×¢×œ ×™×“×™ ×›×œ ×”×¢×•×¡×§×™× ×•×”××¢×•×¨×‘×™× ×‘××—×§×¨ ×•×œ× ×ª×¤×•×¨×¡× ×‘×›×œ ×¤×¨×¡×•× ×›×•×œ×œ ×¤×¨×¡×•××™× ××“×¢×™×™×. ×”× × ×™ ××¦×”×™×¨/×” ×‘×–×” ×›×™ ×”×¡×›××ª×™ ×”× "×œ × ×™×ª× ×” ××¨×¦×•× ×™ ×”×—×•×¤×©×™ ×•×›×™ ×”×‘×™× ×•×ª×™ ××ª ×›×œ ×”×××•×¨ ×œ×¢×™×œ.</p>
    </div>

    <div style="text-align:right;max-width:560px;margin:20px auto 0">
      <p style="font-size:14px;color:var(--text);margin-bottom:8px"><b>×”×ª×¤×§×™×“ ×©×œ×š:</b> ××ª/×” ×× ×”×œ/×ª ×¦×•×•×ª ×©×™×¨×•×ª ×œ×§×•×—×•×ª. ×‘×›×œ ×ª×¨×—×™×© ×ª×¦×˜×¨×š/×™ ×œ×§×‘×œ ×”×—×œ×˜×” × ×™×”×•×œ×™×ª. ×”×× ×”×œ/×ª ×”×™×©×™×¨/×” ×©×œ×š â€” ×× ×”×œ/×ª ×“×™×’×™×˜×œ×™/×ª â€” ×™×œ×•×•×” ××•×ª×š. ×ª×•×›×œ/×™ ×œ×”×ª×™×™×¢×¥, ×œ×©××•×œ ×©××œ×•×ª, ×•×œ×§×‘×œ ×¡×™×•×¢ ×œ×¤× ×™ ×©×ª×—×œ×™×˜/×™.</p>
      <p style="color:var(--error);font-size:13px;background:var(--error-bg);padding:10px 14px;border-radius:8px;margin-top:8px">âš ï¸ ×©×™×/×™ ×œ×‘: ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ ××‘×•×¡×¡ ×¢×œ ×‘×™× ×” ××œ××›×•×ª×™×ª ×•×¢×©×•×™ ×œ×˜×¢×•×ª. ×”×”××œ×¦×•×ª ×©×œ×• ×”×Ÿ ×›×œ×™ ×¢×–×¨ ×‘×œ×‘×“ â€” ×”×”×—×œ×˜×” ×”×¡×•×¤×™×ª ×ª××™×“ ×©×œ×š.</p>
    </div>

    <div style="max-width:560px;margin:20px auto 0;display:flex;gap:12px;justify-content:center">
      <label style="cursor:pointer;display:flex;align-items:center;gap:8px;font-size:15px;font-weight:500;color:var(--text);padding:12px 24px;border:2px solid var(--primary);border-radius:10px;transition:all .2s" id="consentYes">
        <input type="radio" name="consent" value="yes" style="width:18px;height:18px" onchange="$('startBtn').style.display='block';$('noConsentMsg').style.display='none'">
        <span>××¡×›×™×/×”</span>
      </label>
      <label style="cursor:pointer;display:flex;align-items:center;gap:8px;font-size:15px;font-weight:500;color:var(--text2);padding:12px 24px;border:2px solid var(--border);border-radius:10px;transition:all .2s">
        <input type="radio" name="consent" value="no" style="width:18px;height:18px" onchange="$('startBtn').style.display='none';$('noConsentMsg').style.display='block'">
        <span>×œ× ××¡×›×™×/×”</span>
      </label>
    </div>
    <div id="noConsentMsg" style="display:none;max-width:560px;margin:12px auto 0;padding:12px;background:var(--error-bg);border-radius:8px;font-size:14px;color:var(--error)">×ª×•×“×” ×¢×œ ×”×”×ª×¢× ×™×™× ×•×ª. ×œ× × ×™×ª×Ÿ ×œ×”×©×ª×ª×£ ×‘××—×§×¨ ×œ×œ× ×”×¡×›××”.</div>

    ${uc?'':`<div style="margin-top:24px;padding:16px;background:#fff8e1;border-radius:10px;border:1px solid #ffe082;max-width:560px;margin-left:auto;margin-right:auto">
      <p style="font-size:13px;color:#6d4c00;margin:0"><b>××¦×‘ ×‘×“×™×§×”</b> â€” ×‘×—×¨/×™ ×ª× ××™ × ×™×¡×•×™×™:</p>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-secondary" style="flex:1;margin:0;font-size:13px;padding:10px" onclick="ST.cond='A';$('startBtn').style.display='block'">A â€“ × ×™×˜×¨×œ×™</button>
        <button class="btn btn-secondary" style="flex:1;margin:0;font-size:13px;padding:10px" onclick="ST.cond='B';$('startBtn').style.display='block'">B â€“ ×§×•×¤×¡×” ×©×—×•×¨×”</button>
        <button class="btn btn-secondary" style="flex:1;margin:0;font-size:13px;padding:10px" onclick="ST.cond='C';$('startBtn').style.display='block'">C â€“ XAI</button>
      </div>
    </div>`}
    <button class="btn btn-primary" id="startBtn" style="display:none;margin-top:24px;max-width:300px;margin-left:auto;margin-right:auto" onclick="doStart()">â–¶ï¸ ×œ×”×ª×—×™×œ</button>
  </div></div>`;
}

function doStart(){
  if(!ST.cond)return;
  const consent=document.querySelector('input[name="consent"][value="yes"]:checked');
  if(!consent){return}
  ST.survey.consent='yes';
  ST.t0=Date.now();
  if(SKIP_SURVEYS){ST.cur=0;ST.ts.S1={start:Date.now()};ST.phase='scenario';ST.chatHistory=[];ST.chatRounds=0;ST.choiceMade=false}
  else{ST.phase='preDemog'}
  go()
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SURVEY HELPER â€” renders a Likert page
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSurveyPage({title,subtitle,items,scaleMin,scaleMax,anchorLow,anchorHigh,prefix,nextPhase,pageNum,totalPages}){
  const scaleRange=[];for(let i=scaleMin;i<=scaleMax;i++)scaleRange.push(i);
  const surveyProgress=pageNum&&totalPages?`<div style="font-size:13px;color:var(--text2);margin-bottom:12px">×¢××•×“ ${pageNum} ××ª×•×š ${totalPages}</div>`:'';
  app.innerHTML=`<div class="screen"><div class="card" style="max-width:700px;margin:0 auto">
    <div style="direction:rtl;text-align:right"><h2>${title}</h2>
    ${subtitle?`<p style="margin-bottom:20px;font-size:14px;color:var(--text2)">${subtitle}</p>`:''}
    ${surveyProgress}</div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:8px;display:flex;justify-content:space-between;direction:rtl"><span>${anchorHigh}</span><span>${anchorLow}</span></div>
    ${items.map((q,idx)=>`
      <div style="margin-bottom:18px;padding:14px 16px;background:#f8f9fb;border-radius:10px;border:1px solid var(--border)">
        <div style="font-size:14px;margin-bottom:10px;line-height:1.6;direction:ltr;text-align:left">${q}</div>
        <div class="likert-scale" style="direction:ltr">${scaleRange.map(n=>`<label><input type="radio" name="sq_${idx}" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
      </div>`).join('')}
    <div class="error-msg" id="survErr" style="direction:rtl;text-align:right"></div>
    <button class="btn btn-primary" onclick="submitSurveyPage('${prefix}',${items.length},'${nextPhase}')">×”××©×š â†’</button>
  </div></div>`;
}

function submitSurveyPage(prefix,count,nextPhase){
  for(let i=0;i<count;i++){
    const checked=document.querySelector(`input[name="sq_${i}"]:checked`);
    if(!checked){$('survErr').textContent='× × ×œ×¢× ×•×ª ×¢×œ ×›×œ ×”×©××œ×•×ª.';$('survErr').classList.add('show');return}
    ST.survey[`${prefix}${i+1}`]=+checked.value;
  }
  if(nextPhase==='scenario'){ST.cur=0;ST.ts.S1={start:Date.now()};ST.chatHistory=[];ST.chatRounds=0;ST.choiceMade=false}
  if(nextPhase==='done'&&!ST.tEnd){ST.tEnd=Date.now()}
  ST.phase=nextPhase;go();
}

// â”€â”€â”€ Pre-Survey: Demographics â”€â”€â”€
function rPreDemog(){
  app.innerHTML=`<div class="screen"><div class="card" style="max-width:600px;margin:0 auto">
    <h2>×©××œ×•×Ÿ ×¨×§×¢</h2>
    <p style="margin-bottom:20px;font-size:14px;color:var(--text2)">×›××” ×©××œ×•×ª ×§×¦×¨×•×ª ×œ×¤× ×™ ×©× ×ª×—×™×œ.</p>

    <div style="margin-bottom:20px">
      <label class="likert-q">×’×™×œ</label>
      <div class="likert-scale" style="margin-top:8px">
        ${['×¢×“ 30','30â€“50','××¢×œ 50'].map((v,i)=>`<label><input type="radio" name="age" value="${i+1}"><span class="lk" style="padding:10px 20px">${v}</span></label>`).join('')}
      </div>
    </div>

    <div style="margin-bottom:20px">
      <label class="likert-q">××’×“×¨</label>
      <div class="likert-scale" style="margin-top:8px">
        ${['× ×§×‘×”','×–×›×¨','××—×¨','×œ× ××¢×•× ×™×™×Ÿ/×ª ×œ×¢× ×•×ª'].map((v,i)=>`<label><input type="radio" name="gender" value="${i+1}"><span class="lk" style="padding:10px 16px">${v}</span></label>`).join('')}
      </div>
    </div>

    <div style="margin-bottom:20px">
      <label class="likert-q">×”×©×›×œ×”</label>
      <div class="likert-scale" style="margin-top:8px">
        ${['×ª×•××¨ ×¨××©×•×Ÿ','×ª×•××¨ ×©× ×™','×“×•×§×˜×•×¨×˜ ×•××¢×œ×”'].map((v,i)=>`<label><input type="radio" name="edu" value="${i+1}"><span class="lk" style="padding:10px 16px">${v}</span></label>`).join('')}
      </div>
    </div>

    <div style="margin-bottom:20px">
      <label class="likert-q">×ª×—×•× ×”×©×›×œ×”</label>
      <div class="likert-scale" style="margin-top:8px">
        ${['××ª××˜×™×§×” ×•××“×¢×™ ×”××—×©×‘','××—×¨'].map((v,i)=>`<label><input type="radio" name="field" value="${i+1}"><span class="lk" style="padding:10px 16px">${v}</span></label>`).join('')}
      </div>
    </div>

    <div class="error-msg" id="demoErr"></div>
    <button class="btn btn-primary" onclick="submitDemog()">×”××©×š â†’</button>
  </div></div>`;
}

function submitDemog(){
  const age=document.querySelector('input[name="age"]:checked');
  const gender=document.querySelector('input[name="gender"]:checked');
  const edu=document.querySelector('input[name="edu"]:checked');
  const field=document.querySelector('input[name="field"]:checked');
  if(!age||!gender||!edu||!field){$('demoErr').textContent='× × ×œ×¢× ×•×ª ×¢×œ ×›×œ ×”×©××œ×•×ª.';$('demoErr').classList.add('show');return}
  ST.survey.age=+age.value;ST.survey.gender=+gender.value;ST.survey.education=+edu.value;ST.survey.field=+field.value;
  ST.phase='preATAI';go();
}

// â”€â”€â”€ Pre-Survey: ATAI (5 items, 1-5) â”€â”€â”€
function rPreATAI(){
  renderSurveyPage({
    title:'×¢××“×•×ª ×›×œ×¤×™ ×‘×™× ×” ××œ××›×•×ª×™×ª',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“.',
    items:[
      'AI01: I fear artificial intelligence.',
      'AI02: I trust artificial intelligence.',
      'AI03: Artificial intelligence will destroy humankind.',
      'AI04: Artificial intelligence will benefit humankind.',
      'AI05: Artificial intelligence will cause many job losses.'
    ],
    scaleMin:0,scaleMax:10,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (0)',anchorHigh:'××¡×›×™×/×” ×××•×“ (10)',
    prefix:'ATAI',nextPhase:'preGDMS1',pageNum:1,totalPages:6
  });
}

// â”€â”€â”€ Pre-Survey: GDMS split into 3 pages of ~8-9 items â”€â”€â”€
function rPreGDMS1(){
  renderSurveyPage({
    title:'×¡×’× ×•×Ÿ ×§×‘×œ×ª ×”×—×œ×˜×•×ª (1/3)',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“.',
    items:[
      'RAT1: I make decisions in a logical and systematic way.',
      'RAT2: My decision making requires careful thought.',
      'RAT3: I double-check my information sources to be sure I have the right facts before making decisions.',
      'RAT4: When making a decision, I consider various options in terms of a specific goal.',
      'RAT5: I make decisions after finding out all I can about the options.',
      'INT1: When making decisions, I rely upon my instincts.',
      'INT2: I generally make decisions that feel right to me.',
      'INT3: When I make decisions, I tend to rely on my intuition.',
      'INT4: I trust my inner feelings when making decisions.'
    ],
    scaleMin:0,scaleMax:5,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (0)',anchorHigh:'××¡×›×™×/×” ×××•×“ (5)',
    prefix:'GDMS_A',nextPhase:'preGDMS2',pageNum:2,totalPages:6
  });
}

function rPreGDMS2(){
  renderSurveyPage({
    title:'×¡×’× ×•×Ÿ ×§×‘×œ×ª ×”×—×œ×˜×•×ª (2/3)',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“.',
    items:[
      'INT5: I make decisions based on gut feelings.',
      'DEP1: I rarely make important decisions without consulting other people.',
      'DEP2: I like to have someone steer me in the right direction when I am faced with important decisions.',
      'DEP3: If I have the support of others, it is easier for me to make important decisions.',
      'DEP4: I rely on the advice of other people when making important decisions.',
      'DEP5: I often need the assistance of other people when making important decisions.',
      'AVO1: I avoid making important decisions until the pressure is on.',
      'AVO2: I postpone decision making whenever possible.'
    ],
    scaleMin:0,scaleMax:5,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (0)',anchorHigh:'××¡×›×™×/×” ×××•×“ (5)',
    prefix:'GDMS_B',nextPhase:'preGDMS3',pageNum:3,totalPages:6
  });
}

function rPreGDMS3(){
  renderSurveyPage({
    title:'×¡×’× ×•×Ÿ ×§×‘×œ×ª ×”×—×œ×˜×•×ª (3/3)',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“.',
    items:[
      'AVO3: I put off making decisions because thinking about them makes me uneasy.',
      'AVO4: I avoid decision making.',
      'AVO5: I delay making decisions until it is too late.',
      'SPO1: I generally make snap decisions.',
      'SPO2: I make quick decisions.',
      'SPO3: I often make impulsive decisions.',
      'SPO4: I make decisions on the spur of the moment.',
      'SPO5: I make impulsive decisions.'
    ],
    scaleMin:0,scaleMax:5,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (0)',anchorHigh:'××¡×›×™×/×” ×××•×“ (5)',
    prefix:'GDMS_C',nextPhase:'scenario',pageNum:4,totalPages:6
  });
}

// â”€â”€â”€ Post-Survey: PEU (6 items, 1-7) â”€â”€â”€
function rPostPEU(){
  renderSurveyPage({
    title:'×§×œ×•×ª ×©×™××•×© × ×ª×¤×¡×ª',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“ ×œ×’×‘×™ ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™.',
    items:[
      'PEU1: My interaction with the digital manager is clear and understandable.',
      'PEU2: Interacting with the digital manager does not require a lot of mental effort.',
      'PEU3: I find the digital manager easy to use.',
      'PEU4: I find it easy to get the digital manager to do what I want it to do.',
      'PEU5: It is easy for me to become skillful at using the digital manager.',
      'PEU6: I have the knowledge necessary to use the digital manager.'
    ],
    scaleMin:1,scaleMax:7,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (1)',anchorHigh:'××¡×›×™×/×” ×××•×“ (7)',
    prefix:'PEU',nextPhase:'postPPR',pageNum:1,totalPages:6
  });
}

// â”€â”€â”€ Post-Survey: PPR (5 items, 0-5) â”€â”€â”€
function rPostPPR(){
  renderSurveyPage({
    title:'×ª×¤×™×¡×•×ª ×¤×¨×˜×™×•×ª',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“.',
    items:[
      'PPR1: I think conversations with the digital manager can cause personal information to be published.',
      'PPR2: I think conversations with the digital manager may have collected my personal information.',
      'PPR3: I recognize that disclosing personal information through the digital manager is a risk.',
      'PPR4: I recognize that disclosing personal information through the digital manager can have a negative impact on me.',
      'PPR5: Privacy risks are an essential part of my next decision about using the digital manager.'
    ],
    scaleMin:0,scaleMax:5,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (0)',anchorHigh:'××¡×›×™×/×” ×××•×“ (5)',
    prefix:'PPR',nextPhase:'postTRU',pageNum:2,totalPages:6
  });
}

// â”€â”€â”€ Post-Survey: TRU (4 items, 1-7) â”€â”€â”€
function rPostTRU(){
  renderSurveyPage({
    title:'×××•×Ÿ ×‘×× ×”×œ ×”×“×™×’×™×˜×œ×™',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“.',
    items:[
      'TRU1: I believe that this digital manager is trustworthy.',
      'TRU2: I do not doubt the honesty of information provided by this digital manager.',
      'TRU3: I feel assured that this digital manager service has the ability to protect users.',
      'TRU4: Overall, I trust in this digital manager.'
    ],
    scaleMin:1,scaleMax:7,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (1)',anchorHigh:'××¡×›×™×/×” ×××•×“ (7)',
    prefix:'TRU',nextPhase:'postCON',pageNum:3,totalPages:6
  });
}

// â”€â”€â”€ Post-Survey: CON (3 items, 0-5) â”€â”€â”€
function rPostCON(){
  renderSurveyPage({
    title:'××™×©×•×© ×¦×™×¤×™×•×ª',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“ ×œ×’×‘×™ ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™.',
    items:[
      'CON1: My experience with this digital manager was greater than my expectations.',
      'CON2: The service level provided by this digital manager was greater than what I expected.',
      'CON3: In general, most of my expectations from using this digital manager were confirmed.'
    ],
    scaleMin:0,scaleMax:5,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (0)',anchorHigh:'××¡×›×™×/×” ×××•×“ (5)',
    prefix:'CON',nextPhase:'postTransp',pageNum:4,totalPages:6
  });
}

// â”€â”€â”€ Post-Survey: Transparency (12 items, 0-7) â”€â”€â”€
function rPostTransp(){
  renderSurveyPage({
    title:'×©×§×™×¤×•×ª × ×ª×¤×¡×ª',
    subtitle:'×“×¨×’/×™ ×¢×“ ×›××” ××ª/×” ××¡×›×™×/×” ×¢× ×›×œ ×”×™×’×“ ×œ×’×‘×™ ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™.',
    items:[
      'IN1: It was clear to me what kind of data the system uses to generate recommendations.',
      'IN2: I understood what data was used by the system to infer my preferences.',
      'IN3: I understood which item characteristics were considered to generate recommendations.',
      'OU1: I understood why the items were recommended to me.',
      'OU2: I understood why the system determined that the recommended items would suit me.',
      'OU3: I can tell how well the recommendations match my preferences.',
      'FU1: The system provided information to understand why the items were recommended.',
      'FU2: The system provided information about how the quality of the items was determined.',
      'FU3: The system provided information about how my preferences were inferred.',
      'FU4: The system provided information about how well the recommendations match my preferences.',
      'INTR1: I know what actions to perform in the system so that it generates better recommendations.',
      'INTR2: I know what needs to be changed in order to get better recommendations.'
    ],
    scaleMin:0,scaleMax:7,
    anchorLow:'×œ× ××¡×›×™×/×” ×›×œ×œ (0)',anchorHigh:'××¡×›×™×/×” ×××•×“ (7)',
    prefix:'TRANSP',nextPhase:'postUEQ',pageNum:5,totalPages:6
  });
}

// â”€â”€â”€ Post-Survey: UEQ (8 items, semantic differential 0-7) â”€â”€â”€
function rPostUEQ(){
  const pairs=[
    ['Unpleasant','Pleasant'],
    ['Not practical','Practical'],
    ['Complicated','Easy'],
    ['Boring','Exciting'],
    ['Not organized','Organized'],
    ['Inefficient','Efficient'],
    ['Not inventive','Inventive'],
    ['Confusing','Clear']
  ];
  const scaleRange=[0,1,2,3,4,5,6,7];
  app.innerHTML=`<div class="screen"><div class="card" style="max-width:700px;margin:0 auto;direction:ltr;text-align:left">
    <h2>×—×•×•×™×™×ª ××©×ª××©</h2>
    <p style="margin-bottom:20px;font-size:14px;color:var(--text2)">×“×¨×’/×™ ××ª ×”×—×•×•×™×” ×©×œ×š ×¢× ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ ×‘×›×œ ××™××“.</p>
    <div style="font-size:13px;color:var(--text2);margin-bottom:8px">×¢××•×“ 6 ××ª×•×š 6</div>
    ${pairs.map((p,idx)=>`
      <div style="margin-bottom:16px;padding:14px 16px;background:#f8f9fb;border-radius:10px;border:1px solid var(--border)">
        <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--text2);margin-bottom:8px">
          <span>${p[0]}</span><span>${p[1]}</span>
        </div>
        <div class="likert-scale" style="direction:ltr">${scaleRange.map(n=>`<label><input type="radio" name="sq_${idx}" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
      </div>`).join('')}
    <div class="error-msg" id="survErr" style="direction:rtl;text-align:right"></div>
    <button class="btn btn-primary" onclick="submitSurveyPage('UEQ',8,'done')">×¡×™×•× âœ“</button>
  </div></div>`;
}

// â”€â”€â”€ Scenario (with chat) â”€â”€â”€
async function rScenario(){
  const i=ST.cur, s=SCENARIOS[i];
  ST.chatHistory=[];ST.chatRounds=0;ST.choiceMade=false;

  const hasAI = ST.cond==='B'||ST.cond==='C';

  app.innerHTML=`<div class="screen">${pBar()}<div class="layout with-chat"><div class="card scenario-card">
    <span class="scenario-badge">×ª×¨×—×™×© ${i+1} ××ª×•×š 5</span>
    <h2>${s.title}</h2>
    <div class="bg-text">${s.background}</div>
    <div class="table-wrap">${s.tableHTML}</div>
    <div class="legend">${s.legend}</div>
    <div class="task-text">ğŸ“‹ ××©×™××”: ${s.task}</div>
    <div class="options-text">${s.validOptions}</div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="chat-header">
      <div class="avatar">${hasAI?'ğŸ¤–':'ğŸ’¬'}</div>
      <div><div class="name">${hasAI?'×”×× ×”×œ ×”×“×™×’×™×˜×œ×™':'×ª×™×‘×ª ×”×—×œ×˜×”'}</div><div class="status">${hasAI?'××§×•×•×Ÿ':''}</div></div>
    </div>
    <div class="chat-messages" id="chatMsgs">
      ${hasAI?'<div class="typing" id="typing"><span></span><span></span><span></span></div>':''}
    </div>
    ${hasAI?`<div class="rounds-left" id="roundsLeft"></div>`:''}
    <div class="chat-input" id="chatInput" style="${hasAI?'display:none':'display:flex'}">
      <input id="chatText" placeholder="${hasAI?'×©××œ/×™ ×©××œ×” ××• ×”×–×Ÿ/×™ ×‘×—×™×¨×”...':(s.placeholder||'×”×–×Ÿ/×™ ×‘×—×™×¨×”...')}" onkeydown="if(event.key==='Enter')handleChatSubmit()">
      <button onclick="handleChatSubmit()">×©×œ×—</button>
    </div>
  </div>

  </div></div>`;

  enhanceMobileCards();

  // Condition A: show instruction in chat
  if(!hasAI){
    addChatBubble('ğŸ“‹ ' + s.inputLabel,'system');
  }

  // Conditions B/C: generate initial AI message
  if(hasAI){
    const msgs=buildLLMMessages(i, 'initial');
    const reply = await callLLM(msgs);
    ST.chatHistory.push({role:'assistant',content:reply});
    const typingEl=$('typing');
    if(typingEl)typingEl.remove();
    addChatBubble(reply,'ai');
    addChatBubble('×›×“×™ ×œ×‘×—×•×¨: ' + s.inputLabel,'system');
    $('chatInput').style.display='flex';
    updateRoundsLeft();
  }

  // RTL/LTR auto-detect for mixed input (Hebrew questions + English/number choices)
  const it=$('chatText');
  if(it){
    const syncDir=()=>{
      const v=(it.value||'').trim();
      const isLTR=/^[0-9A-Za-z]/.test(v);
      it.style.direction=isLTR?'ltr':'rtl';
      it.style.textAlign=isLTR?'left':'right';
    };
    it.addEventListener('input',syncDir);
    it.addEventListener('focus',syncDir);
    syncDir();
  }
}

function buildLLMMessages(idx, type, userMsg=''){
  const s=SCENARIOS[idx];
  const sys={role:'system',content:sysPrompt(idx)};
  if(type==='initial'){
    const condPrompt = ST.cond==='B'
      ? `×›×ª×•×‘/×›×ª×‘×™ ×‘×“×™×•×§ 2 ××©×¤×˜×™× ×§×¦×¨×™×:
1) ××©×¤×˜ ×©××›×•×•×Ÿ ×œ×§×¨×™×˜×¨×™×•×Ÿ ×—×©×•×‘ ×‘×¨××” ×’×‘×•×”×”, ×‘×œ×™ ×œ× ×§×•×‘ ×‘××¤×©×¨×•×ª ×¡×¤×¦×™×¤×™×ª (×œ××©×œ: "×›×“××™ ×œ×—×©×•×‘ ×¢×œ ××” ×§×•×¨×” ×›×©×“×—×™×¤×•×ª ×’×‘×•×”×” ×•×¡×™×›×•×Ÿ ×œ×œ×§×•×— ×’× ×’×‘×•×”").
2) ×©××œ×” ×©××§×“××ª ×”×—×œ×˜×” ("××” ×™×•×ª×¨ ×—×©×•×‘ ×œ×š â€” ___ ××• ___?").
*** ××¡×•×¨: ×œ×”×–×›×™×¨ ×©×/××•×ª/××¡×¤×¨ ×©×œ ××¤×©×¨×•×ª. ××¡×•×¨: "×× ×™ ×××œ×™×¥", "×ª×‘×—×¨". ×¨×§ ×§×¨×™×˜×¨×™×•× ×™× ×›×œ×œ×™×™×. ***`
      : `×›×ª×•×‘/×›×ª×‘×™ ×¢×“ 3 ××©×¤×˜×™× ×§×¦×¨×™×:
1) ×©××œ ×¢×œ ×”×§×¨×™×˜×¨×™×•× ×™× ×”×—×©×•×‘×™× ×œ××©×ª×ª×£ â€” ×œ××©×œ "××” ×—×©×•×‘ ×œ×š ×™×•×ª×¨ â€” ×“×—×™×¤×•×ª, ×”×©×¤×¢×” ×¢×œ ×”×œ×§×•×—, ××• ××”×™×¨×•×ª ×˜×™×¤×•×œ?"
2) ×¦×™×™×Ÿ trade-off ×›×œ×œ×™ (×‘×œ×™ ×“×•×’×××•×ª ×¡×¤×¦×™×¤×™×•×ª ××”×˜×‘×œ×”).
3) ×¡×™×™× ×‘"×”×”×—×œ×˜×” ×”×¡×•×¤×™×ª â€” ×©×œ×š."
*** ×‘×”×•×“×¢×” ×”×¨××©×•× ×”: ××¡×•×¨ ×œ×”×–×›×™×¨ ××¤×©×¨×•×™×•×ª ×¡×¤×¦×™×¤×™×•×ª ×›××• "VIP", "××•×‘×“×Ÿ ××™×“×¢", ×©××•×ª × ×¦×™×’×™×. ×¨×§ ×§×¨×™×˜×¨×™×•× ×™× ×›×œ×œ×™×™×. ×“×•×’×××•×ª ×¡×¤×¦×™×¤×™×•×ª ××•×ª×¨×•×ª ×¨×§ ×‘×”×•×“×¢×•×ª ×”××©×š. ***`;
    return [sys, {role:'user',content:condPrompt}];
  }
  // Follow-up
  const history = ST.chatHistory.map(m=>({role:m.role,content:m.content}));
  const payload = followupStyle() + "\n\n×©××œ×ª ×”××©×ª×ª×£: " + normalizeUserForLLM(userMsg);
  return [sys, ...history, {role:'user',content:payload}];
}

// Unified handler: detect if input is a choice or a question
function handleChatSubmit(){
  const input=$('chatText');
  const txt=input.value.trim();
  if(!txt)return;

  const i=ST.cur, s=SCENARIOS[i];
  const hasAI=ST.cond==='B'||ST.cond==='C';

  // Try to validate as a choice
  const validated=s.validate(txt);

  if(validated!==null){
    // It's a valid choice â€” submit it
    addChatBubble(txt,'user');
    input.value='';
    ST.D[s.dKey]=validated;

    // Save chat logs
    if(ST.chatHistory.length>0){
      ST.allChatLogs[`S${i+1}`]=ST.chatHistory.map(m=>({r:m.role==='assistant'?'ai':'user',t:m.content.substring(0,300)}));
    }

    // Confirmation
    if(hasAI){
      if($('chatInput'))$('chatInput').style.display='none';
      addChatBubble('×”×‘×—×™×¨×” × ×§×œ×˜×”. ×ª×•×“×”.','ai');
      if(ST.cond==='C'&&s.microExplanation){
        addChatBubble(s.microExplanation,'ai');
      }
    }else{
      if($('chatInput'))$('chatInput').style.display='none';
      addChatBubble('âœ… ×”×‘×—×™×¨×” × ×§×œ×˜×”.','system');
    }
    setTimeout(()=>{ST.phase='likert1';go()},800);
  } else if(hasAI && ST.chatRounds<CONFIG.MAX_CHAT_ROUNDS){
    // Check for filler/acknowledgment words â€” respond locally without LLM call
    const filler=/^(×˜×•×‘|××•×§×™|××•×§×™×™|ok|okay|×”×‘× ×ª×™|×‘×¨×•×¨|×›×Ÿ|×¡×‘×‘×”|×ª×•×“×”|×™×•×¤×™|× ×•)\.?$/i;
    if(filler.test(txt.trim())){
      addChatBubble(txt,'user');
      input.value='';
      const s2=SCENARIOS[ST.cur];
      addChatBubble(`××– ××” ×”×”×—×œ×˜×” ×©×œ×š? ${s2.inputLabel}`,'ai');
      return;
    }
    // It's a question â€” send to AI
    sendChat();
  } else if(!hasAI){
    // Condition A â€” invalid choice
    addChatBubble(txt,'user');
    input.value='';
    addChatBubble('âŒ ' + s.inputLabel,'system');
  } else {
    // B/C but out of rounds â€” must be a choice attempt
    addChatBubble(txt,'user');
    input.value='';
    addChatBubble('âŒ ×”×§×œ×˜ ×œ× ×ª×§×™×Ÿ. ' + s.inputLabel,'system');
  }
}

async function sendChat(){
  const input=$('chatText');
  const txt=input.value.trim();
  if(!txt||ST.chatRounds>=CONFIG.MAX_CHAT_ROUNDS)return;

  // Track chat metrics
  const sKey=`S${ST.cur+1}`;
  if(!ST.chatMsgCount[sKey])ST.chatMsgCount[sKey]=0;
  ST.chatMsgCount[sKey]++;
  if(!ST.chatFirstMsgTime[sKey])ST.chatFirstMsgTime[sKey]=Date.now();

  addChatBubble(txt,'user');
  ST.chatHistory.push({role:'user',content:txt});
  input.value='';
  ST.chatRounds++;

  // Show typing
  const msgArea=$('chatMsgs');
  const typingEl=document.createElement('div');
  typingEl.className='typing';typingEl.id='typing2';
  typingEl.innerHTML='<span></span><span></span><span></span>';
  msgArea.appendChild(typingEl);
  msgArea.scrollTop=msgArea.scrollHeight;

  const msgs=buildLLMMessages(ST.cur,'followup',txt);
  const reply=await callLLM(msgs);
  ST.chatHistory.push({role:'assistant',content:reply});

  typingEl.remove();
  addChatBubble(reply,'ai');
  updateRoundsLeft();

  // Save chat incrementally after each AI reply (delayed to avoid overlap)
  const logs=ST.chatHistory.map(m=>({r:m.role==='assistant'?'ai':'user',t:m.content.substring(0,300)}));
  setTimeout(()=>saveChatLog(ST.cur, logs), 3000);

  if(ST.chatRounds>=CONFIG.MAX_CHAT_ROUNDS){
    addChatBubble('×”×’×¢×ª ×œ××›×¡×ª ×”×©××œ×•×ª. ×”×–×Ÿ/×™ ××ª ×‘×—×™×¨×ª×š.','system');
  }
}

function enhanceMobileCards(){
  document.querySelectorAll('.table-wrap table').forEach(table=>{
    const headerRow=table.querySelector('tr');
    if(!headerRow)return;
    const headers=Array.from(headerRow.querySelectorAll('th')).map(th=>th.textContent.trim());
    Array.from(table.querySelectorAll('tr')).slice(1).forEach(tr=>{
      Array.from(tr.querySelectorAll('td')).forEach((td,idx)=>{
        if(!td.hasAttribute('data-label'))td.setAttribute('data-label',headers[idx]||'');
      });
      const pill=tr.querySelector('.pill');
      if(pill){
        if(pill.classList.contains('u5'))tr.style.setProperty('--row-accent','var(--error)');
        else if(pill.classList.contains('u4')||pill.classList.contains('u3'))tr.style.setProperty('--row-accent','#9c6f00');
        else if(pill.classList.contains('u2'))tr.style.setProperty('--row-accent','#006644');
        else if(pill.classList.contains('u1'))tr.style.setProperty('--row-accent','#495057');
      }
    });
  });
}

function addChatBubble(text,type){
  const msgArea=$('chatMsgs');
  const div=document.createElement('div');
  div.className=`msg ${type}`;
  div.textContent=text;
  msgArea.appendChild(div);
  msgArea.scrollTop=msgArea.scrollHeight;
}

function updateRoundsLeft(){
  const el=$('roundsLeft');
  if(!el)return;
  const left=CONFIG.MAX_CHAT_ROUNDS-ST.chatRounds;
  el.textContent=left>0?`${left} ×©××œ×•×ª × ×•×ª×¨×•`:'';
}

function doSubmit(){
  // Legacy â€” redirects to handleChatSubmit
  handleChatSubmit();
}

// â”€â”€â”€ Likert â”€â”€â”€
function rLikert1(){
  const i=ST.cur;
  const qText1 = ST.cond==='A'
    ? '×¢×“ ×›××” ×”×¡×ª××›×ª ×¢×œ ××™×“×¢ ×—×™×¦×•× ×™ (××¢×‘×¨ ×œ× ×ª×•× ×™× ×©×”×•×¦×’×•) ×‘×§×‘×œ×ª ×”×”×—×œ×˜×”?'
    : '×¢×“ ×›××” ×”×¡×ª××›×ª ×¢×œ ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ ×‘×§×‘×œ×ª ×”×”×—×œ×˜×”?';
  app.innerHTML=`<div class="screen">${pBar()}<div class="card">
    <span class="scenario-badge">×ª×¨×—×™×© ${i+1} â€” ×©××œ×•×ª</span>

    <div style="margin-bottom:28px">
      <div class="likert-q">1. ${qText1}</div>
      <div class="likert-scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="r" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
      <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
    </div>

    <div>
      <div class="likert-q">2. ×¢×“ ×›××” ××ª/×” ×‘×˜×•×—/×” ×‘×”×—×œ×˜×” ×©×§×™×‘×œ×ª?</div>
      <div class="likert-scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="c" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
      <div class="likert-anchors"><span>×‘×›×œ×œ ×œ× ×‘×˜×•×—/×”</span><span>×‘×˜×•×—/×” ×××•×“</span></div>
    </div>

    <button class="btn btn-primary" id="likertSubmit" style="margin-top:24px;opacity:0.5;pointer-events:none" onclick="doLikertSubmit()">×”××©×š</button>
  </div></div>`;

  // Enable button when both answered
  document.querySelectorAll('input[name="r"],input[name="c"]').forEach(r=>r.addEventListener('change',()=>{
    const r1=document.querySelector('input[name="r"]:checked');
    const r2=document.querySelector('input[name="c"]:checked');
    const btn=$('likertSubmit');
    if(r1&&r2){btn.style.opacity='1';btn.style.pointerEvents='auto'}
  }));
}

function doLikertSubmit(){
  const r1=document.querySelector('input[name="r"]:checked');
  const r2=document.querySelector('input[name="c"]:checked');
  if(!r1||!r2)return;
  const i=ST.cur;
  ST.R[`R${i+1}`]=+r1.value;
  ST.C[`C${i+1}`]=+r2.value;
  ST.ts[`S${i+1}`].end=Date.now();
  // Save chat log only if user had actual interaction
  const sKey=`S${i+1}`;
  if(ST.allChatLogs[sKey]&&ST.allChatLogs[sKey].length>0&&ST.chatMsgCount[sKey]>0){
    saveChatLog(i, ST.allChatLogs[sKey]);
  }
  setTimeout(()=>{if(i<4){ST.cur=i+1;ST.ts[`S${i+2}`]={start:Date.now()};ST.phase='scenario'}else{ST.tEnd=Date.now();ST.phase='manipCheck'}go()},200);
}

function rLikert2(){rLikert1()}

// â”€â”€â”€ Manipulation Check (3 questions after all scenarios) â”€â”€â”€
function rManipCheck(){
  app.innerHTML=`<div class="screen">
    <div class="progress-bar">${[0,1,2,3,4].map(()=>'<div class="progress-step done"></div>').join('')}</div>
    <div class="card">
      <h2>×©××œ×•×ª ×¡×™×•×</h2>
      <p>×›××¢×˜ ×¡×™×™×× ×• â€” ×¢×•×“ 3 ×©××œ×•×ª ×§×¦×¨×•×ª ×¢×œ ×”×—×•×•×™×” ×”×›×œ×œ×™×ª.</p>

      <div style="margin:24px 0">
        <div class="likert-q">1. ×¢×“ ×›××” ×”×¨×’×©×ª ×©×”××™×“×¢ ×©×§×™×‘×œ×ª ×”×™×” ×©×§×•×£ ×•××•×‘×Ÿ?</div>
        <div class="likert-scale" id="mc1Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="mc1" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
        <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
      </div>

      <div style="margin:24px 0">
        <div class="likert-q">2. ×¢×“ ×›××” ×”×¨×’×©×ª ×©×”×”××œ×¦×•×ª ×©×§×™×‘×œ×ª ×”×™×• ×× ×•××§×•×ª ×•××•×¡×‘×¨×•×ª?</div>
        <div class="likert-scale" id="mc2Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="mc2" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
        <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
      </div>

      <div style="margin:24px 0">
        <div class="likert-q">3. ×¢×“ ×›××” ××ª/×” ×¡×•××›/×ª ×¢×œ ×”×× ×”×œ ×”×“×™×’×™×˜×œ×™ ×©×œ×™×•×•×” ××•×ª×š?</div>
        <div class="likert-scale" id="mc3Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="mc3" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
        <div class="likert-anchors"><span>×‘×›×œ×œ ×œ×</span><span>×‘××™×“×” ×¨×‘×” ×××•×“</span></div>
      </div>

      <div style="margin:24px 0;padding:16px 20px;background:#f8f9fb;border-radius:10px;border:1px solid var(--border)">
        <div class="likert-q">4. ×œ×¦×•×¨×š ×‘×§×¨×ª ××™×›×•×ª â€” ×× × ×¡××Ÿ/×™ ××ª ×”××¡×¤×¨ 4.</div>
        <div class="likert-scale" id="mc4Scale">${[1,2,3,4,5,6,7].map(n=>`<label><input type="radio" name="attn" value="${n}"><span class="lk">${n}</span></label>`).join('')}</div>
      </div>

      <div class="error-msg" id="mcErr"></div>
      <button class="btn btn-primary" onclick="submitManipCheck()">×¡×™×•× âœ“</button>
    </div></div>`;
}

function submitManipCheck(){
  const mc1=document.querySelector('input[name="mc1"]:checked');
  const mc2=document.querySelector('input[name="mc2"]:checked');
  const mc3=document.querySelector('input[name="mc3"]:checked');
  const attn=document.querySelector('input[name="attn"]:checked');
  if(!mc1||!mc2||!mc3||!attn){$('mcErr').textContent='× × ×œ×¢× ×•×ª ×¢×œ ×›×œ ×”×©××œ×•×ª.';$('mcErr').classList.add('show');return}
  ST.MC={MC_transparency:+mc1.value, MC_explainability:+mc2.value, MC_trust:+mc3.value, attention_check:+attn.value===4?'pass':'fail'};
  if(SKIP_SURVEYS){ST.phase='done'}else{ST.phase='postPEU'}
  go();
}

// â”€â”€â”€ Done â”€â”€â”€
async function rDone(){
  const rawTime=Math.round((ST.tEnd-ST.t0)/1000);
  app.innerHTML=`<div class="screen">
    <div class="progress-bar">${[0,1,2,3,4].map(()=>'<div class="progress-step done"></div>').join('')}</div>
    <div class="card" style="text-align:center;padding:40px 32px">
      <div style="font-size:48px;margin-bottom:16px">ğŸ‰</div>
      <h2>×”×¡×™××•×œ×¦×™×” ×”×¡×ª×™×™××”!</h2>
      <p style="margin-top:12px">×›×œ ×”×ª×©×•×‘×•×ª, ×”×–×× ×™× ×•×”×“×™×¨×•×’×™× × ×©××¨×• ××•×˜×•××˜×™×ª.</p>
      <div class="saving-status" id="ss" style="font-size:15px;margin:20px 0">â³ ×©×•××¨ × ×ª×•× ×™×...</div>
      <p style="font-size:14px;color:var(--text2)">×–××Ÿ ×›×•×œ×œ: ${rawTime} ×©× ×™×•×ª Â· ×§×‘×•×¦×”: ${ST.cond}</p>
      <br><p style="font-size:18px;color:var(--text)">×ª×•×“×” ×¨×‘×” ×¢×œ ×”×”×©×ª×ª×¤×•×ª! ğŸ™</p>
    </div></div>`;
  const res=await saveToSheets(buildRow());const el=$('ss');
  if(res.ok){el.innerHTML='âœ… ×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”';el.style.color='var(--success)'}
  else if(res.reason==='no_url'){el.innerHTML='âš ï¸ ×©××™×¨×” ××•×˜×•××˜×™×ª ×œ× ×”×•×’×“×¨×”';el.style.color='#e68a00'}
  else{el.innerHTML='âš ï¸ ××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×” â€” × × ×œ×¤× ×•×ª ×œ×—×•×§×¨/×ª';el.style.color='var(--error)'}
}

function doCopy(){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
go();
</script>
</body>
</html>
